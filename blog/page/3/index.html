
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>No Fucking Idea</title>
  <meta name="author" content="Jakub Oboza">

  
  <meta name="description" content="redis cluster in currently unstable, i used todays master HEAD (93a74949d7bb5d0c4115d1bf45f856c368badf31) commit to build my redis server and client &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://no-fucking-idea.com/blog/page/3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="No Fucking Idea" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-17523816-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">No Fucking Idea</a></h1>
  
    <h2>Common answer to everything</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:no-fucking-idea.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/link-lib">LIB!</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/16/setting-up-redis-cluster/">Setting Up Redis Cluster</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-16T19:54:00+01:00" pubdate data-updated="true">Apr 16<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/04/16/setting-up-redis-cluster/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>redis cluster in currently unstable, i used todays master HEAD (93a74949d7bb5d0c4115d1bf45f856c368badf31) commit to build my redis server and client. Setting redis cluster requires only few settings to go! :)</p>

<p>Here is link to overview how redis cluster works <a href="http://redis.io/presentation/Redis_Cluster.pdf">http://redis.io/presentation/Redis_Cluster.pdf</a></p>

<h1>redis.conf</h1>

<p>Regular nodes can&#8217;t be part of cluster :( so you have to prepare separate redis configs for your cluster servers.
Most important thing is to setup <code>cluster-enabled</code> and <code>cluster-config-file</code> I decided to name my config files <code>redis-cluster-&lt;port&gt;.conf</code>. I used ports 4444, 4445 4446
Here is my sample config</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>daemonize yes
</span><span class='line'>timeout 0
</span><span class='line'>loglevel notice
</span><span class='line'>logfile stdout
</span><span class='line'>databases 16
</span><span class='line'>save 900 1
</span><span class='line'>save 300 10
</span><span class='line'>save 60 10000
</span><span class='line'>stop-writes-on-bgsave-error yes
</span><span class='line'>rdbcompression yes
</span><span class='line'>rdbchecksum yes
</span><span class='line'>dbfilename dump.rdb
</span><span class='line'>dir ./cluster_4444
</span><span class='line'>slave-serve-stale-data yes
</span><span class='line'>slave-read-only yes
</span><span class='line'>appendonly no
</span><span class='line'>appendfsync everysec
</span><span class='line'>no-appendfsync-on-rewrite no
</span><span class='line'>auto-aof-rewrite-percentage 100
</span><span class='line'>auto-aof-rewrite-min-size 64mb
</span><span class='line'>lua-time-limit 5000
</span><span class='line'>
</span><span class='line'><span class="c"># Cluster</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'>pidfile /var/run/redis-4444.pid
</span><span class='line'>port 4444
</span><span class='line'>cluster-enabled yes
</span><span class='line'>cluster-config-file redis-cluster-4444.conf
</span><span class='line'>
</span><span class='line'>slowlog-log-slower-than 10000
</span><span class='line'>slowlog-max-len 1024
</span><span class='line'><span class="nb">hash</span>-max-ziplist-entries 512
</span><span class='line'><span class="nb">hash</span>-max-ziplist-value 64
</span><span class='line'>list-max-ziplist-entries 512
</span><span class='line'>list-max-ziplist-value 64
</span><span class='line'><span class="nb">set</span>-max-intset-entries 512
</span><span class='line'>zset-max-ziplist-entries 128
</span><span class='line'>zset-max-ziplist-value 64
</span><span class='line'>activerehashing yes
</span><span class='line'>client-output-buffer-limit normal 0 0 0
</span><span class='line'>client-output-buffer-limit slave 256mb 64mb 60
</span><span class='line'>client-output-buffer-limit pubsub 32mb 8mb 60
</span></code></pre></td></tr></table></div></figure>


<p>For each node i created directory <code>cluster_&lt;port&gt;</code> and that was the hardest part actually to do. With this all you have to do is to start ( for debug you can set daemonize to no) all nodes using <code>redis-server path/to/redis-cluster-&lt;port&gt;.conf</code> and then use magic ruby tool :)</p>

<h1>redis-tribe.rb</h1>

<p>In <code>src/</code> directory of source you can find ruby script for creating and managing cluster. But first you need to have ruby installed with <code>redis</code> gem. i just did <code>gem install redis</code> but if you don&#8217;t have ruby you have to google how to install it etc (hint: get 1.9.2).</p>

<p>now you can run the script. <code>./redis-tribe.rb</code> and see</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ ./redis-trib.rb
</span><span class='line'>Usage: redis-trib &lt;<span class="nb">command</span>&gt; &lt;arguments ...&gt;
</span><span class='line'>
</span><span class='line'>  create               host1:port host2:port ... hostN:port
</span><span class='line'>  check                host:port
</span><span class='line'>  reshard              host:port
</span></code></pre></td></tr></table></div></figure>


<p>To start cluster we will type &#8220;create&#8221; (useless comment)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ ./redis-trib.rb create 127.0.0.1:4444 127.0.0.1:4445 127.0.0.1:4446
</span><span class='line'>Creating cluster
</span><span class='line'>Connecting to node 127.0.0.1:4444: OK
</span><span class='line'>Connecting to node 127.0.0.1:4445: OK
</span><span class='line'>Connecting to node 127.0.0.1:4446: OK
</span><span class='line'>Performing <span class="nb">hash </span>slots allocation on 3 nodes...
</span><span class='line'><span class="o">[</span>FAIL<span class="o">]</span> 5a2f6df453f1cd52bcb22c2afc45580283bcce87 127.0.0.1:4444 slots:0-1364 <span class="o">(</span>1365 slots<span class="o">)</span>
</span><span class='line'><span class="o">[</span>FAIL<span class="o">]</span> 35d107017bc726ece9b57e1ea2f21678555cf6a8 127.0.0.1:4445 slots:1365-2729 <span class="o">(</span>1365 slots<span class="o">)</span>
</span><span class='line'><span class="o">[</span>FAIL<span class="o">]</span> 76d06b0d3cb1b3829cb60574260dff2d06964cea 127.0.0.1:4446 slots:2730-4095 <span class="o">(</span>1366 slots<span class="o">)</span>
</span><span class='line'>Can I <span class="nb">set </span>the above configuration? <span class="o">(</span><span class="nb">type</span> <span class="s1">&#39;yes&#39;</span> to accept<span class="o">)</span>: yes
</span><span class='line'>** Nodes configuration updated
</span><span class='line'>** Sending CLUSTER MEET messages to join the cluster
</span><span class='line'>Performing Cluster Check <span class="o">(</span>using node 127.0.0.1:4444<span class="o">)</span>
</span><span class='line'><span class="o">[</span>FAIL<span class="o">]</span> 5a2f6df453f1cd52bcb22c2afc45580283bcce87 127.0.0.1:4444 slots:0-1364 <span class="o">(</span>1365 slots<span class="o">)</span>
</span><span class='line'><span class="o">[</span>FAIL<span class="o">]</span> 35d107017bc726ece9b57e1ea2f21678555cf6a8 127.0.0.1:4445 slots:1365-2729 <span class="o">(</span>1365 slots<span class="o">)</span>
</span><span class='line'><span class="o">[</span>FAIL<span class="o">]</span> 76d06b0d3cb1b3829cb60574260dff2d06964cea 127.0.0.1:4446 slots:2730-4095 <span class="o">(</span>1366 slots<span class="o">)</span>
</span><span class='line'><span class="o">[</span>OK<span class="o">]</span> All 4096 slots covered.
</span></code></pre></td></tr></table></div></figure>


<p>Nice we have our cluster running :) now we can connect to any node and try it out.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ ./redis-cli -h 127.0.0.1 -p 4445
</span><span class='line'>redis 127.0.0.1:4445&gt; <span class="nb">set</span> <span class="s2">&quot;jakub&quot;</span> <span class="s2">&quot;oboza&quot;</span>
</span><span class='line'><span class="o">(</span>error<span class="o">)</span> MOVED 198 127.0.0.1:4444
</span></code></pre></td></tr></table></div></figure>


<p>Sweet :D</p>

<p>Using this tool you can also reshard :D I did on my 15 keys worked :-F.</p>

<h1>Smart clients</h1>

<p>In redis doc we can read that you will require &#8220;smart client&#8221; to make it low latency. Yes, you can read from output that it was moved so you will have to cache where the key is now and reset temp cache when it will be moved (resharding)</p>

<h1>Fire!</h1>

<p>You can now test how it will behaves under fire by killing and restarting your nodes eg.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>19008<span class="o">]</span> 16 Apr 19:44:09.945 <span class="c"># Server started, Redis version 2.9.7</span>
</span><span class='line'><span class="o">[</span>19008<span class="o">]</span> 16 Apr 19:44:09.946 * The server is now ready to accept connections on port 4444
</span><span class='line'><span class="o">[</span>19008<span class="o">]</span> 16 Apr 19:45:14.414 * Connecting with Node c20290a7b70a2a840a168c3309f00e3de1b1844d at 127.0.0.1:14446
</span><span class='line'><span class="o">[</span>19008<span class="o">]</span> 16 Apr 19:45:15.424 * Connecting with Node ab93647957ed4bb93fc43b1dc76202a6cdb94f49 at 127.0.0.1:14445
</span><span class='line'><span class="o">[</span>19008<span class="o">]</span> 16 Apr 19:59:10.047 * 1 changes in 900 seconds. Saving...
</span><span class='line'><span class="o">[</span>19008<span class="o">]</span> 16 Apr 19:59:10.047 * Background saving started by pid 19321
</span><span class='line'><span class="o">[</span>19321<span class="o">]</span> 16 Apr 19:59:10.080 * DB saved on disk
</span><span class='line'><span class="o">[</span>19008<span class="o">]</span> 16 Apr 19:59:10.248 * Background saving terminated with success
</span><span class='line'><span class="o">[</span>19008<span class="o">]</span> 16 Apr 20:08:29.837 * I/O error reading from node link: connection closed
</span><span class='line'><span class="o">[</span>19008<span class="o">]</span> 16 Apr 20:08:29.837 * I/O error reading from node link: connection closed
</span><span class='line'><span class="o">[</span>19008<span class="o">]</span> 16 Apr 20:08:30.056 * Connecting with Node 76d06b0d3cb1b3829cb60574260dff2d06964cea at 127.0.0.1:14446
</span><span class='line'><span class="o">[</span>19008<span class="o">]</span> 16 Apr 20:08:30.056 * I/O error writing to node link: Broken pipe
</span><span class='line'><span class="o">[</span>19008<span class="o">]</span> 16 Apr 20:08:30.525 * I/O error reading from node link: connection closed
</span><span class='line'><span class="o">[</span>19008<span class="o">]</span> 16 Apr 20:08:30.526 * I/O error reading from node link: connection closed
</span><span class='line'><span class="o">[</span>19008<span class="o">]</span> 16 Apr 20:08:31.063 * Connecting with Node 35d107017bc726ece9b57e1ea2f21678555cf6a8 at 127.0.0.1:14445
</span><span class='line'><span class="o">[</span>19008<span class="o">]</span> 16 Apr 20:08:31.064 * Connecting with Node 76d06b0d3cb1b3829cb60574260dff2d06964cea at 127.0.0.1:14446
</span></code></pre></td></tr></table></div></figure>


<h1>Summary</h1>

<p>Even if i think this is a great tool, and is unstable i saw after few minutes play that some things just don&#8217;t work as intended and some keys are not pushed. But it is pulled from unstable branch so i&#8217;m crossing my fingers for this project because it looks sweet! Go Go Antirez.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/12/building-orm-slash-odm-using-virtus-for-mongodb-part-1/">Building ORM/ODM Using Virtus for MongoDB Part 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-12T21:07:00+01:00" pubdate data-updated="true">Apr 12<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/04/12/building-orm-slash-odm-using-virtus-for-mongodb-part-1/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This blog post is start of series on building ORM/ODM libraries for Mongodb in different languages. I am a big fan of mongoid <a href="http://mongoid.org">http://mongoid.org</a> great Ruby ODM for mongodb. But i am even bigger fan of Mongodb <a href="http://www.mongodb.org/">http://www.mongodb.org/</a>. Some time ago i saw post by my friend from <a href="http://www.lunarlogicpolska.com/">http://www.lunarlogicpolska.com/</a> about <code>virtus</code> <a href="http://solnic.eu/2011/06/06/virtus---attributes-for-your-plain-ruby-objects.html">http://solnic.eu/2011/06/06/virtus&#8212;attributes-for-your-plain-ruby-objects.html</a> (it&#8217;s really worth reading) and i thought &#8220;it&#8217;s nice&#8221;. Today i have spent two hours to cook this starter project because i want to learn more about <code>virtus</code> and building ODM&#8217;s ORM&#8217;s is not so common topic across web.</p>

<h1>Aim</h1>

<p>Building fully featured ODM in two hours from scratch is more then you can expect from me. Goal if first part is to make something that will map ruby PORO&#8217;s to mongodb collections, be able to save them, find one or many in database and destroy. This looks like a lot but we will do it slowly and the implementation will be very basic. Our ODM will be named &#8220;Muppet&#8221;. Name describes the project :).</p>

<h3>Virtus</h3>

<p>Virtus handles properties for Plain Old Ruby Objects and this is all we need to have. This eliminates a lot of boilerplate code we would have to write to make anything work. PORO Powah!</p>

<h3>Mongo</h3>

<p><code>mongo</code> is a Mongodb native ruby driver. It has really good api and is easy to use. For most things in this post i just <code>proxied</code> calls to it :).</p>

<h3>Database!</h3>

<p>Be sure to have mongodb working ;).</p>

<h1>First step: Building a gem</h1>

<p>All about building gem you can find in my previous blog post here <a href="http://no-fucking-idea.com/blog/2012/04/11/building-gem-with-bundler/">http://no-fucking-idea.com/blog/2012/04/11/building-gem-with-bundler/</a>
Be sure to add rspec :) i used it to describe tests for this project.</p>

<h1>Second step: Describing api</h1>

<p>I like do develop things in TDD/BDD style so first thing for me description of api i wanted to implement during this tutorial.
All this specs are stripped to minimum to enhance readability.</p>

<figure class='code'><figcaption><span>spec/muppet_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Virtus</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Muppet</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">attribute</span> <span class="ss">:age</span><span class="p">,</span> <span class="nb">Integer</span>
</span><span class='line'>  <span class="n">attribute</span> <span class="ss">:birthday</span><span class="p">,</span> <span class="no">DateTime</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="no">Muppet</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;#configuration&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should be configurable&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="nb">lambda</span> <span class="k">do</span>
</span><span class='line'>        <span class="no">Muppet</span><span class="o">.</span><span class="n">configure</span> <span class="p">{{</span>
</span><span class='line'>          <span class="n">host</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="n">port</span><span class="p">:</span> <span class="mi">27017</span><span class="p">,</span>
</span><span class='line'>          <span class="n">database</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span>
</span><span class='line'>        <span class="p">}}</span>
</span><span class='line'>        <span class="no">Muppet</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">should</span> <span class="n">be_a</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
</span><span class='line'>        <span class="no">Muppet</span><span class="o">.</span><span class="n">config</span><span class="o">[</span><span class="ss">:host</span><span class="o">].</span><span class="n">should</span> <span class="n">eql</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span><span class="o">.</span><span class="n">should_not</span> <span class="n">raise_error</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should by default point to localhost:27017&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="nb">lambda</span> <span class="k">do</span>
</span><span class='line'>        <span class="no">Muppet</span><span class="o">.</span><span class="n">config</span><span class="o">[</span><span class="ss">:host</span><span class="o">].</span><span class="n">should</span> <span class="n">eql</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="no">Muppet</span><span class="o">.</span><span class="n">config</span><span class="o">[</span><span class="ss">:port</span><span class="o">].</span><span class="n">should</span> <span class="n">eql</span><span class="p">(</span><span class="mi">27017</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;#connection&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should connect to mongodb&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="nb">lambda</span> <span class="k">do</span>
</span><span class='line'>        <span class="no">Muppet</span><span class="o">.</span><span class="n">connect!</span>
</span><span class='line'>      <span class="k">end</span><span class="o">.</span><span class="n">should_not</span> <span class="n">raise_error</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;#inserting&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should insert values to database&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">pending</span>
</span><span class='line'>      <span class="nb">lambda</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Jakub&quot;</span><span class="p">,</span> <span class="n">age</span><span class="p">:</span> <span class="mi">27</span> <span class="p">)</span>
</span><span class='line'>        <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
</span><span class='line'>      <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;#quering&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should query all documents from collection&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">pending</span>
</span><span class='line'>      <span class="no">User</span><span class="o">.</span><span class="n">find_one</span><span class="o">.</span><span class="n">should</span> <span class="n">be_a</span><span class="p">(</span><span class="no">User</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should query first document from collection&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">pending</span>
</span><span class='line'>      <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span>
</span><span class='line'>      <span class="n">users</span><span class="o">.</span><span class="n">should</span> <span class="n">be_a</span><span class="p">(</span><span class="nb">Array</span><span class="p">)</span>
</span><span class='line'>      <span class="n">users</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">should</span> <span class="n">be_a</span><span class="p">(</span><span class="no">User</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;#destroy&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should destroy document&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">pending</span>
</span><span class='line'>      <span class="nb">lambda</span> <span class="k">do</span>
</span><span class='line'>        <span class="no">User</span><span class="o">.</span><span class="n">find_one</span><span class="o">.</span><span class="n">destroy</span>
</span><span class='line'>      <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I defined them in order how i wanted to implement this. First configuration and connection to db. Next inserting and querying and destroying as last thing. Also at top i have simple User object with <code>virtus</code> and <code>muppet</code> included.</p>

<h1>Third step: layouting Muppet!</h1>

<p>At this moment we should have ready specs, that fail hard throwing errors on unknown tokens. Its good.
What i did is simple <code>lib/muppet.rb</code> defines the module we will include into out PORO&#8217;s.</p>

<figure class='code'><figcaption><span>muppet.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;mongo&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;muppet/version&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;muppet/setup&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Muppet</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">Muppet</span><span class="o">::</span><span class="no">Setup</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>in <code>lib/muppet/</code> we will have components of our project. I we already know we will start with setup as defined in <code>muppet.rb</code> so lets create file <code>lib/muppet/setup</code> and configuration and connection to mongodb.</p>

<figure class='code'><figcaption><span>lib/muppet/setup.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Muppet</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Setup</span>
</span><span class='line'>    <span class="vc">@@configuration</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">host</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">port</span><span class="p">:</span> <span class="mi">27017</span><span class="p">,</span>
</span><span class='line'>      <span class="n">database</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_config</span><span class="p">)</span>
</span><span class='line'>      <span class="vc">@@configuration</span><span class="o">.</span><span class="n">merge!</span><span class="p">(</span><span class="n">user_config</span><span class="o">.</span><span class="n">call</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">config</span>
</span><span class='line'>      <span class="vc">@@configuration</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">connect!</span>
</span><span class='line'>      <span class="vc">@@connection</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vc">@@configuration</span><span class="o">[</span><span class="ss">:host</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>        <span class="vc">@@configuration</span><span class="o">[</span><span class="ss">:port</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="vc">@@database</span> <span class="o">=</span> <span class="vc">@@connection</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="vc">@@configuration</span><span class="o">[</span><span class="ss">:database</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">database</span>
</span><span class='line'>      <span class="vc">@@database</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">connection</span>
</span><span class='line'>      <span class="vc">@@connection</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here i defined default configuration and few method to access vital part of our config like <code>database</code> , <code>connection</code>. Most important part is <code>connect!</code> this method uses mongo gem to establish connection to mongodb store it into connection variable and set the database we will be working on. I wanted to make few things explicit so i used some name redundancy. (later on i learned that i did not even need <code>config</code> method)</p>

<p>With this working we can run out rspecs and if mongodb is up we should see all green and few yellows! Good it works!</p>

<h1>Forth step: support for quering and inserting</h1>

<p>Now lets remove pending marks from specs that  are in &#8220;describes&#8221; quering and inserting. This will be the heart of our ODM. We will define how he should save and load object from database. Before this we will have to update out <code>lib/muppet.rb</code> to include things we will use.</p>

<figure class='code'><figcaption><span>lib/muppet.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;mongo&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;muppet/version&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;muppet/setup&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;muppet/document&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Muppet</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">Muppet</span><span class="o">::</span><span class="no">Setup</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Muppet</span><span class="o">::</span><span class="no">Document</span><span class="o">::</span><span class="no">InstanceMethods</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="no">Muppet</span><span class="o">::</span><span class="no">Document</span><span class="o">::</span><span class="no">ClassMethods</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok many new things. I created <code>lib/muppet/document.rb</code> module with the stuff we will put into class and instance definitions in the moment of inclusion. As we can see in definition of <code>User</code> in our test cases we will <code>include Muppet</code> so all the instance methods like (save, destroy) will have to be defined in separated module then class methods like (find_one, find). In <code>document.rb</code> we  can see how it is implemented.</p>

<figure class='code'><figcaption><span>lib/muppet/document.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Muppet</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Document</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">collection_name</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">collection</span>
</span><span class='line'>        <span class="no">Muppet</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">collection_name</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">find_one</span><span class="p">(</span><span class="n">opts</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="kp">nil</span> <span class="k">unless</span> <span class="n">result</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="n">opts</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>        <span class="n">results</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
</span><span class='line'>        <span class="n">results</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">result</span><span class="o">|</span> <span class="nb">self</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">count</span>
</span><span class='line'>        <span class="n">collection</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">module</span> <span class="nn">InstanceMethods</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">save</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I could not think of a way to implement it in a more simple way. We have to &#8220;sections&#8221; first is class methods where we define</p>

<ul>
<li>collection_name this method says to us what is the collection name (we can override it in model)</li>
<li>collection uses database to return this collection object for us to use.</li>
<li>find_one, find, count are methods that we proxy in a dirty explicit way (but without using method missing) things to mongo native driver.</li>
</ul>


<p>Only thing we do here is to wrap things that we get back into <code>self.new</code> object. So we can mimic AR/Mongoid api and when doing User.find we will get back array of all users. not array of hashes :).</p>

<p>Instance methods are only two <code>save</code> and <code>destroy</code> save is raw and simple, takes all attributes from using virtues and saves them using mongo native driver. destroy acts in the same way.</p>

<p>Now we can run the specs and see all is green. We have a basic ODM where we can add documents, map and query them to PORO&#8217;s and remove.</p>

<h1>Summary</h1>

<p>I really enjoyed writing this code and blog post :).
You can find code for this blog post here <a href="https://github.com/JakubOboza/muppet">https://github.com/JakubOboza/muppet</a></p>

<p>This code is buggy and even specs needs to be enhanced but this is a good start for building new features on top of it. In  future parts i want to implement, updating, proxy objects, relations, embedded objects, dirty tracking(probably using <a href="https://github.com/solnic/virtus-dirty_tracking">https://github.com/solnic/virtus-dirty_tracking</a>) and few other mechanism that will enable us to make a fully functional ODM from &#8220;Muppet&#8221;</p>

<p>-Cheers</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/11/building-gem-with-bundler/">Building Gem With Bundler</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-11T20:09:00+01:00" pubdate data-updated="true">Apr 11<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/04/11/building-gem-with-bundler/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Building a new gem ( ruby library ) with bundler is easy task. I found a lot of tutorial on this topic in the web but none of them was covering more then just generating scaffold and packing up the gem. I will try to uncover a bit more. So at the end of this post you will be able to generate new gem, build it and it will have ready support for rspec.</p>

<p>First of all you need bundler. To install bundler just type <code>gem install bundler</code>. Probably most of you guys have it already :) but just in case.</p>

<h1>Generating new gem</h1>

<p>To generate gem scaffold all you have to do is call <code>bundle gem &lt;gem name&gt;</code> like here</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bundle gem doctor_toons
</span><span class='line'>      create  doctor_toons/Gemfile
</span><span class='line'>      create  doctor_toons/Rakefile
</span><span class='line'>      create  doctor_toons/LICENSE
</span><span class='line'>      create  doctor_toons/README.md
</span><span class='line'>      create  doctor_toons/.gitignore
</span><span class='line'>      create  doctor_toons/doctor_toons.gemspec
</span><span class='line'>      create  doctor_toons/lib/doctor_toons.rb
</span><span class='line'>      create  doctor_toons/lib/doctor_toons/version.rb
</span><span class='line'>Initializating git repo in /private/tmp/doctor_toons
</span></code></pre></td></tr></table></div></figure>


<p>This will create directory named doctor_toons with:</p>

<ul>
<li>Gemfile where we specify production and development gems</li>
<li>Rakefile with our rake tasks, you need to remember that rake is not part of Gemfile if you are using ruby &lt; 1.9.2</li>
<li>License file with license, GPL, BSD, MIT, LOL choose one and put it in by default MIT.</li>
<li>it initializes git repo inside this directory and adds .gitignore with default ignores</li>
</ul>


<figure class='code'><figcaption><span>.gitignore</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ cat .gitignore
</span><span class='line'>*.gem
</span><span class='line'>*.rbc
</span><span class='line'>.bundle
</span><span class='line'>.config
</span><span class='line'>.yardoc
</span><span class='line'>Gemfile.lock
</span><span class='line'>InstalledFiles
</span><span class='line'>_yardoc
</span><span class='line'>coverage
</span><span class='line'>doc/
</span><span class='line'>lib/bundler/man
</span><span class='line'>pkg
</span><span class='line'>rdoc
</span><span class='line'>spec/reports
</span><span class='line'><span class="nb">test</span>/tmp
</span><span class='line'><span class="nb">test</span>/version_tmp
</span><span class='line'>tmp
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>lib directory for your code !!!</li>
<li>&lt; name >.gemspec file with whole gemspec for our gem.</li>
</ul>


<p>First thing we need to do is set gems we will be using while building our lib. Initial <code>Gemfile</code> looks like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ cat Gemfile
</span><span class='line'><span class="nb">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Specify your gem&#39;s dependencies in doctor_toons.gemspec</span>
</span><span class='line'>gemspec
</span></code></pre></td></tr></table></div></figure>


<p>All production needed gems needs to be added before <code>gemspec</code>. So if we will want to add rspec as <em>development</em> dependency we need to put it after <code>gemspec</code> term in Gemfile. Eg. if we want to use mongo 1.6.2 as production dependency and rspec 2.9.0 as our development dependency we should do it like this.</p>

<figure class='code'><figcaption><span>cat Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
</span><span class='line'>
</span><span class='line'>gem <span class="s1">&#39;mongo&#39;</span>, <span class="s1">&#39;~&gt; 1.6.2&#39;</span>
</span><span class='line'>gem <span class="s1">&#39;bson&#39;</span>,  <span class="s1">&#39;~&gt; 1.6.2&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Specify your gem&#39;s dependencies in doctor_toons.gemspec</span>
</span><span class='line'>gemspec
</span><span class='line'>
</span><span class='line'>gem <span class="s1">&#39;rspec&#39;</span>, <span class="s1">&#39;~&gt; 2.9.0&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can simply bundle all dependencies for our gem by hitting. <code>bundle install</code> you should see something like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ bundle install
</span><span class='line'>Fetching gem metadata from https://rubygems.org/....
</span><span class='line'>Using bson <span class="o">(</span>1.6.2<span class="o">)</span>
</span><span class='line'>Using diff-lcs <span class="o">(</span>1.1.3<span class="o">)</span>
</span><span class='line'>Using doctor_toons <span class="o">(</span>0.0.1<span class="o">)</span> from <span class="nb">source </span>at /private/tmp/doctor_toons
</span><span class='line'>Using mongo <span class="o">(</span>1.6.2<span class="o">)</span>
</span><span class='line'>Using rspec-core <span class="o">(</span>2.9.0<span class="o">)</span>
</span><span class='line'>Using rspec-expectations <span class="o">(</span>2.9.1<span class="o">)</span>
</span><span class='line'>Using rspec-mocks <span class="o">(</span>2.9.0<span class="o">)</span>
</span><span class='line'>Using rspec <span class="o">(</span>2.9.0<span class="o">)</span>
</span><span class='line'>Using bundler <span class="o">(</span>1.1.0<span class="o">)</span>
</span><span class='line'>Your bundle is <span class="nb">complete</span>! Use <span class="sb">`</span>bundle show <span class="o">[</span>gemname<span class="o">]</span><span class="sb">`</span> to see where a bundled gem is installed.
</span></code></pre></td></tr></table></div></figure>


<h1>Building gem!</h1>

<p>Ok now we are ready for next step, building gem! To do it we call <code>gem build &lt; name &gt;.gemspec</code> so lets do it</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ gem build doctor_toons.gemspec
</span><span class='line'>ERROR:  While executing gem ... <span class="o">(</span>Gem::InvalidSpecificationException<span class="o">)</span>
</span><span class='line'>    <span class="s2">&quot;FIXME&quot;</span> or <span class="s2">&quot;TODO&quot;</span> is not a description
</span></code></pre></td></tr></table></div></figure>


<p>Error. This means that we need to supply few things before we will build this gem. First of all we need to <code>emacs &lt; name &gt;.gemspec</code> to edit the file with gemspec and set few things. By default this file should look like this</p>

<figure class='code'><figcaption><span>doctor_toons.gemspec</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># -*- encoding: utf-8 -*-</span>
</span><span class='line'><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../lib/doctor_toons/version&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="no">Gem</span><span class="o">::</span><span class="no">Specification</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">gem</span><span class="o">|</span>
</span><span class='line'>  <span class="n">gem</span><span class="o">.</span><span class="n">authors</span>       <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;JakubOboza&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">gem</span><span class="o">.</span><span class="n">email</span>         <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;jakub.oboza@gmail.com&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">gem</span><span class="o">.</span><span class="n">description</span>   <span class="o">=</span> <span class="sx">%q{TODO: Write a gem description}</span>
</span><span class='line'>  <span class="n">gem</span><span class="o">.</span><span class="n">summary</span>       <span class="o">=</span> <span class="sx">%q{TODO: Write a gem summary}</span>
</span><span class='line'>  <span class="n">gem</span><span class="o">.</span><span class="n">homepage</span>      <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">gem</span><span class="o">.</span><span class="n">executables</span>   <span class="o">=</span> <span class="sb">`git ls-files -- bin/*`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">gem</span><span class="o">.</span><span class="n">files</span>         <span class="o">=</span> <span class="sb">`git ls-files`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">gem</span><span class="o">.</span><span class="n">test_files</span>    <span class="o">=</span> <span class="sb">`git ls-files -- {test,spec,features}/*`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">gem</span><span class="o">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s2">&quot;doctor_toons&quot;</span>
</span><span class='line'>  <span class="n">gem</span><span class="o">.</span><span class="n">require_paths</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;lib&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">gem</span><span class="o">.</span><span class="n">version</span>       <span class="o">=</span> <span class="no">DoctorToons</span><span class="o">::</span><span class="no">VERSION</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>
So lets edit description and summary and build again our gem. <code>gem build doctor_toons.gemspec</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ gem build doctor_toons.gemspec
</span><span class='line'>WARNING:  no homepage specified
</span><span class='line'>  Successfully built RubyGem
</span><span class='line'>  Name: doctor_toons
</span><span class='line'>  Version: 0.0.1
</span><span class='line'>  File: doctor_toons-0.0.1.gem
</span></code></pre></td></tr></table></div></figure>


<p>Yeah now we can build our gem :)
Lets have a look at gemspec <code>gem spec doctor_toons-0.0.1.gem</code> before we will be adding rspec to it :)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> λ gem spec doctor_toons-0.0.1.gem
</span><span class='line'>--- !ruby/object:Gem::Specification
</span><span class='line'>name: doctor_toons
</span><span class='line'>version: !ruby/object:Gem::Version
</span><span class='line'>  version: 0.0.1
</span><span class='line'>  segments:
</span><span class='line'>  <span class="nb">hash</span>:
</span><span class='line'>platform: ruby
</span><span class='line'>authors:
</span><span class='line'>- JakubOboza
</span><span class='line'>autorequire:
</span><span class='line'>bindir: bin
</span><span class='line'>cert_chain: <span class="o">[]</span>
</span><span class='line'>date: 2012-04-11 00:00:00.000000000Z
</span><span class='line'>dependencies: <span class="o">[]</span>
</span><span class='line'>description: He sleeps with a gun, but he loves his son
</span><span class='line'>email:
</span><span class='line'>- jakub.oboza@gmail.com
</span><span class='line'>executables: <span class="o">[]</span>
</span><span class='line'>extensions: <span class="o">[]</span>
</span><span class='line'>extra_rdoc_files: <span class="o">[]</span>
</span><span class='line'>files:
</span><span class='line'>- .gitignore
</span><span class='line'>- Gemfile
</span><span class='line'>- LICENSE
</span><span class='line'>- README.md
</span><span class='line'>- Rakefile
</span><span class='line'>- doctor_toons.gemspec
</span><span class='line'>- lib/doctor_toons.rb
</span><span class='line'>- lib/doctor_toons/version.rb
</span><span class='line'>homepage: <span class="s1">&#39;&#39;</span>
</span><span class='line'>licenses: <span class="o">[]</span>
</span><span class='line'>post_install_message:
</span><span class='line'>rdoc_options: <span class="o">[]</span>
</span><span class='line'>require_paths:
</span><span class='line'>- lib
</span><span class='line'>required_ruby_version: !ruby/object:Gem::Requirement
</span><span class='line'>  none: <span class="nb">false</span>
</span><span class='line'><span class="nb">  </span>requirements:
</span><span class='line'>  - - ! <span class="s1">&#39;&gt;=&#39;</span>
</span><span class='line'>    - !ruby/object:Gem::Version
</span><span class='line'>      version: <span class="s1">&#39;0&#39;</span>
</span><span class='line'>      segments:
</span><span class='line'>      <span class="nb">hash</span>:
</span><span class='line'>required_rubygems_version: !ruby/object:Gem::Requirement
</span><span class='line'>  none: <span class="nb">false</span>
</span><span class='line'><span class="nb">  </span>requirements:
</span><span class='line'>  - - ! <span class="s1">&#39;&gt;=&#39;</span>
</span><span class='line'>    - !ruby/object:Gem::Version
</span><span class='line'>      version: <span class="s1">&#39;0&#39;</span>
</span><span class='line'>      segments:
</span><span class='line'>      <span class="nb">hash</span>:
</span><span class='line'>requirements: <span class="o">[]</span>
</span><span class='line'>rubyforge_project:
</span><span class='line'>rubygems_version: 1.8.15
</span><span class='line'>signing_key:
</span><span class='line'>specification_version: 3
</span><span class='line'>summary: Psycho dad
</span><span class='line'>test_files: <span class="o">[]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Everything is fine.</p>

<h1>Adding testing support</h1>

<p>Before we will be wiriting any library code its nice to add support for testing framework. I like name of rspec and rspec as a lib. It lets you define in form of tests specification for your library.</p>

<h2>Rspec</h2>

<p>Adding rspec to our project is easy. All we need to do it create directory called <code>spec</code> and file inside of it called <code>spec_helper.rb</code> like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ mkdir spec
</span><span class='line'>λ touch spec/spec_helper.rb
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to edit <code>spec_helper.rb</code> and add few things.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>require <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'>require <span class="s1">&#39;bundler/setup&#39;</span>
</span><span class='line'><span class="c"># our gem</span>
</span><span class='line'>require <span class="s1">&#39;doctor_toons&#39;</span>
</span><span class='line'>
</span><span class='line'>RSpec.configure <span class="k">do</span> |config|
</span><span class='line'>
</span><span class='line'>end
</span></code></pre></td></tr></table></div></figure>


<p>This is bare minimum <code>spec_helper.rb</code> file we can have. All we do is require on rubygems, bundler setup and our gem <code>doctor_toons</code> :). To make it easy to use we should expand our rake with a spec task! like this</p>

<figure class='code'><figcaption><span>Rakefile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env rake</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;bundler/gem_tasks&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rspec/core/rake_task&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">::</span><span class="no">Core</span><span class="o">::</span><span class="no">RakeTask</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;spec&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">task</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="ss">:spec</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will add <code>rspec</code> task called <code>rake spec</code> that will run all our specs :)
Now last thing we need to add first initial spec to our <code>spec</code> folder so we will be able to test it.</p>

<figure class='code'><figcaption><span>spec/doctor_toons_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="no">DoctorToons</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;should rock&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">lambda</span> <span class="k">do</span>
</span><span class='line'>      <span class="no">DoctorToons</span><span class="o">.</span><span class="n">rock</span><span class="p">()</span>
</span><span class='line'>    <span class="k">end</span><span class="o">.</span><span class="n">should_not</span> <span class="n">raise_error</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Remember spec file names has to end with <code>_spec.rb</code></p>

<p>Now if you will run <code>rake spec</code> you should see something like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Users/kuba/.rvm/rubies/ruby-1.9.2-p290/bin/ruby -S rspec ./spec/doctor_toons_spec.rb
</span><span class='line'>F
</span><span class='line'>
</span><span class='line'>Failures:
</span><span class='line'>
</span><span class='line'>  1<span class="o">)</span> DoctorToons should rock
</span><span class='line'>     Failure/Error: lambda <span class="k">do</span>
</span><span class='line'><span class="k">       </span>expected no Exception, got <span class="c">#&lt;NoMethodError: undefined method `rock&#39; for DoctorToons:Module&gt;</span>
</span><span class='line'>     <span class="c"># ./spec/doctor_toons_spec.rb:6:in `block (2 levels) in &lt;top (required)&gt;&#39;</span>
</span><span class='line'>
</span><span class='line'>Finished in 0.00218 seconds
</span><span class='line'>1 example, 1 failure
</span><span class='line'>
</span><span class='line'>Failed examples:
</span><span class='line'>
</span><span class='line'>rspec ./spec/doctor_toons_spec.rb:5 <span class="c"># DoctorToons should rock</span>
</span><span class='line'>rake aborted!
</span><span class='line'>/Users/kuba/.rvm/rubies/ruby-1.9.2-p290/bin/ruby -S rspec ./spec/doctor_toons_spec.rb failed
</span><span class='line'>
</span><span class='line'>Tasks: <span class="nv">TOP</span> <span class="o">=</span>&gt; spec
</span><span class='line'><span class="o">(</span>See full trace by running task with --trace<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wooow works :) now you can implement your library to rock the world!</p>

<h2>Few useful things</h2>

<p>If you want to have colorful output like me :). You can add <code>.rspec</code> file in top dir of project with content like this</p>

<figure class='code'><figcaption><span>.rspec</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>--color
</span><span class='line'>--format documentation
</span></code></pre></td></tr></table></div></figure>


<p>First line adds color output and second line is format out spec output, it is nice because its the most verbose output. You can easy see where spec failed. When you are on early stage of the project and you have few describes like 50-100 it often helps to develop faster.</p>

<h1>Summary</h1>

<p>This is just intro post about my upcoming series on building tools that you need :).
Fingers crossed :)</p>

<p>-Cheers!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/05/testing-handlebars-with-mocha/">Testing Handlebars With Mocha</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-05T21:01:00+01:00" pubdate data-updated="true">Apr 5<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/04/05/testing-handlebars-with-mocha/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Mocha and Handlebars are two great things i use. Mocha is a testing library which can be used for backend (node.js) and fronend testing. On frontend its only dependency is jQuery. Handlebars is templating language that can be used for frontend javascript partials or even for backend (node.js) layouts. What ever you want! :).</p>

<h1>Mocha</h1>

<p>When i started working with <code>express.js</code> sinatra like framework i took a peek at other projects that people from Vision Media do.
One of them was mocha and at that time i needed something to test my backend code. It is good to use such a tool while learning new thing. This was you can document your failures :). As i found it is  also great tool to test front end code.</p>

<h2>Chai.js / Should.js</h2>

<p>Because Mocha is not shipped with everything i like i decided to use <code>should.js</code> <a href="https://github.com/visionmedia/should.js">https://github.com/visionmedia/should.js</a> on backend (node.js) and <code>chai.js</code> on frontend to make my tests suits more <code>rspec</code> like. This way we will be able to write our specs like this.</p>

<figure class='code'><figcaption><span>app.spec.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Application&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should exists&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>       <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Application</span><span class="p">();</span>
</span><span class='line'>       <span class="nx">app</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">an</span><span class="p">.</span><span class="k">instanceof</span><span class="p">(</span><span class="nx">Application</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>I really like this <code>app.should.be.an.instanceof(Application);</code> syntax. But if you don&#8217;t like it you can use more jasmine like syntax all info can be found here <a href="http://visionmedia.github.com/mocha/">http://visionmedia.github.com/mocha/</a>.</p>

<h1>Handlebars</h1>

<p>Second very useful thing that i never skip in my project is Handlebars, easy to use and clean language to build templates in javascript. Simply it is <code>mustache</code> on steroids. But lets dive straight into some example.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'> <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">&quot;list-entry&quot;</span> <span class="na">type=</span><span class="s">&quot;text/x-handlebars-template&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">li</span> <span class="p"></span> <span class="kr">class</span><span class="o">=</span><span class="p"></span> <span class="p">&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nx">span</span><span class="o">&gt;</span><span class="p"></span><span class="o">&lt;</span><span class="err">/span&gt; -&gt; </span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">strong</span><span class="o">&gt;</span><span class="p"></span><span class="o">&lt;</span><span class="err">/strong&gt;:&amp;nbsp;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">span</span><span class="o">&gt;</span><span class="p"></span><span class="o">&lt;</span><span class="err">/span&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">/li&gt;</span>
</span><span class='line'> <span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This sample show how to in easy way embed handlebars into your html code. Important thing is that only code in <code>is getting interpolated. so in this example ` class= ` mans that if in rendering context we have class variable render `class=value_of_class_variable_in_context` as part of li element.</code> will render contents of this var from context. If there is no variable with this name or it is undefined it will not be rendered. thats the important bit that can make some debugging harder. Eg. <code>underscore.js</code> templates explode if you don&#8217;t have any param that you use inside of them.</p>

<h1>Both tools in action</h1>

<p>Ok so lets try it out and write some code in bdd style using handlebars. I have prepared initial setup for this, it contains lib directory with our javascripts, spec directory with out specs and support directory with our mocha.js, chai.js etc. Our test runner is single index.html file we can open in browser. All the code can be downloaded here <a href="https://github.com/JakubOboza/handlebars-and-mocha">https://github.com/JakubOboza/handlebars-and-mocha</a></p>

<h2>Step one</h2>

<p>Lets write a spec that makes checks if out app loads</p>

<figure class='code'><figcaption><span>app.spec.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Application&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should exists&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>       <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Application</span><span class="p">();</span>
</span><span class='line'>       <span class="nx">app</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">an</span><span class="p">.</span><span class="k">instanceof</span><span class="p">(</span><span class="nx">Application</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://img814.imageshack.us/img814/1738/screenshot20120405at215.png" alt="Failing spec" />
Obviously we have here a failing spec.
Lets write some implementation to satisfy out spec.</p>

<figure class='code'><figcaption><span>app.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">Application</span><span class="p">(</span><span class="nx">template_id</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://img833.imageshack.us/img833/1738/screenshot20120405at215.png" alt="Success spec" />
Bang everything works fine :). Lets make it do something useful, render some templates!
First lets write a spec for it -></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should render handlebars template&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Application</span><span class="p">(</span><span class="s2">&quot;#test-template&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">app</span><span class="p">.</span><span class="nx">render</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;kuba&quot;</span><span class="p">}).</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;kuba&lt;/p&gt;&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://img862.imageshack.us/img862/9451/screenshot20120405at220.png" alt="Failing spec" />
Now lets implement this, our template will look like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'> <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">&quot;test-template&quot;</span> <span class="na">type=</span><span class="s">&quot;text/x-handlebars-template&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p"></span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'> <span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is very basic, hard to make mistake ;). And javascript code</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">Application</span><span class="p">(</span><span class="nx">template_id</span><span class="p">){</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">template_id</span><span class="p">);</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="nx">Handlebars</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">html</span><span class="p">());</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Application</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">){</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://img684.imageshack.us/img684/2551/screenshot20120405at221.png" alt="Success" />
Works! Like a charm!
I really enjoy writing tests for javascript this way. It is much more like rspec. At least for me it is much more useful then jasmine</p>

<h1>Why not jasmine</h1>

<p>I prefer syntax of Mocha. On this few examples i think i show how to start using it and how fun it is. For people with rspec background this should be very easy tool to pick up. More about Mocha can be found on official project page <a href="http://visionmedia.github.com/mocha/">http://visionmedia.github.com/mocha/</a>.</p>

<h2>Example code for this post</h2>

<p>Can be found here <a href="https://github.com/JakubOboza/handlebars-and-mocha">https://github.com/JakubOboza/handlebars-and-mocha</a> just open <code>index.html</code> :)</p>

<p>Cheers!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/01/using-map-reduce-with-mongodb/">Using Map Reduce With Mongodb</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-01T23:05:00+01:00" pubdate data-updated="true">Apr 1<span>st</span>, 2012</time>
        
         | <a href="/blog/2012/04/01/using-map-reduce-with-mongodb/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Mongodb has support for running Map Reduce queries besides having regular sql like query interface. In documentation we can read that it is not the best idea to use it as a regular interface but it is very good for generating things in backgrounds like preparing reports or caching some data. I will try to show simple example how to create a useful map reduce query and execute it.</p>

<h2>Javascript</h2>

<p>Map reduce queries in Mongodb are written in javascript. All you have to do is to prepare two regular javascript functions</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="cm">/* emit values for each document */</span>
</span><span class='line'>  <span class="nx">emit</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In map function you have to emit key -> values from document, eg. for each document emit urls and counts of them.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">reduce</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">){</span>
</span><span class='line'>    <span class="cm">/* reduce emited values into result */</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span><span class="nx">result1</span><span class="o">:</span> <span class="nx">one</span><span class="p">,</span> <span class="nx">result2</span><span class="o">:</span> <span class="nx">two</span><span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In reduce function you simple gather results and sum them up. It is easier to think about if you will imagine that reduce is something like fold or inject (depending on background) on emitted values from mapping function.</p>

<h2>Running scripts</h2>

<p>Mongo db has a really nice interface for running scripts. Lets examine a simple example</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mongo localhost:27017/canis_production generate_report.js
</span></code></pre></td></tr></table></div></figure>


<p>This will run <code>generate_report.js</code> script on database <code>canis_production</code> on db node <code>localhost:27017</code>. You don&#8217;t need to do it, but its easiet to write it into file then type each time functions ;).</p>

<h1>Example Map reduce query</h1>

<p>Now this is a simple mapReduce that actually do something. It is emitting for each document url field and value 1. Reducer is
adding values for the same key so this way we will know how many occurrences of each url we have across whole collection.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="nx">emit</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">reduce</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">values</span><span class="p">){</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">values</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span> <span class="nx">res</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">});</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span><span class="nx">count</span><span class="o">:</span> <span class="nx">res</span><span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>this is have we defined out map reduce functions now all we need to do is just runt he query.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">db</span><span class="p">.</span><span class="nx">sites</span><span class="p">.</span><span class="nx">mapReduce</span><span class="p">(</span><span class="nx">map</span><span class="p">,</span> <span class="nx">reduce</span><span class="p">,</span> <span class="p">{</span> <span class="nx">out</span><span class="o">:</span> <span class="s2">&quot;mapped_urls&quot;</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>To run mapReduce we are using <code>mapReduce</code> function on collection (this example uses collection named &#8220;sites&#8221;), first argument is map function, second is reduce function and third is option but very useful, it is output collection where results will be stored in form of documents. This option lets us run the query at eg. night and see results in the morning :).</p>

<h2>Lets test it</h2>

<p>First some sample data</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">sites</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;www.google.com&quot;</span><span class="p">,</span> <span class="nx">date</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="nx">trash_data</span><span class="o">:</span> <span class="mi">5</span> <span class="p">});</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">sites</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;www.no-fucking-idea.com&quot;</span><span class="p">,</span> <span class="nx">date</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="nx">trash_data</span><span class="o">:</span> <span class="mi">13</span> <span class="p">});</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">sites</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;www.google.com&quot;</span><span class="p">,</span> <span class="nx">date</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="nx">trash_data</span><span class="o">:</span> <span class="mi">1</span> <span class="p">});</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">sites</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;www.no-fucking-idea.com&quot;</span><span class="p">,</span> <span class="nx">date</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="nx">trash_data</span><span class="o">:</span> <span class="mi">69</span> <span class="p">});</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">sites</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;www.no-fucking-idea.com&quot;</span><span class="p">,</span> <span class="nx">date</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="nx">trash_data</span><span class="o">:</span> <span class="mi">256</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>now functions and query</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="o">&gt;</span> <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'><span class="p">...</span>   <span class="nx">emit</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="o">&gt;</span> <span class="kd">var</span> <span class="nx">reduce</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">values</span><span class="p">){</span>
</span><span class='line'><span class="p">...</span>   <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">...</span>   <span class="nx">values</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span> <span class="nx">res</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">});</span>
</span><span class='line'><span class="p">...</span>   <span class="k">return</span> <span class="p">{</span><span class="nx">count</span><span class="o">:</span> <span class="nx">res</span><span class="p">};</span>
</span><span class='line'><span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">sites</span><span class="p">.</span><span class="nx">mapReduce</span><span class="p">(</span><span class="nx">map</span><span class="p">,</span> <span class="nx">reduce</span><span class="p">,</span> <span class="p">{</span> <span class="nx">out</span><span class="o">:</span> <span class="s2">&quot;mapped_urls&quot;</span> <span class="p">});</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;result&quot;</span> <span class="o">:</span> <span class="s2">&quot;mapped_urls&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;timeMillis&quot;</span> <span class="o">:</span> <span class="mi">75</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;counts&quot;</span> <span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="s2">&quot;input&quot;</span> <span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;emit&quot;</span> <span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;reduce&quot;</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;output&quot;</span> <span class="o">:</span> <span class="mi">2</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="s2">&quot;ok&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And results</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">mapped_urls</span><span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
</span><span class='line'><span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="s2">&quot;www.google.com&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;count&quot;</span> <span class="o">:</span> <span class="mi">2</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="s2">&quot;www.no-fucking-idea.com&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;count&quot;</span> <span class="o">:</span> <span class="mi">3</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Worked perfect ;)</p>

<h1>Docs</h1>

<p>More information on map reduce interface you can find in documentation for mongodb <a href="http://www.mongodb.org/display/DOCS/MapReduce">http://www.mongodb.org/display/DOCS/MapReduce</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/31/caching-and-serving-stale-content-with-nginx/">Caching and Serving Stale Content With Nginx</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-31T20:18:00+01:00" pubdate data-updated="true">Mar 31<span>st</span>, 2012</time>
        
         | <a href="/blog/2012/03/31/caching-and-serving-stale-content-with-nginx/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Caching</h1>

<p>With ruby and rails we often want to have caching of static content so we will try to reduce requests that has to come through rails stack when possible. Nginx in front is a great tool and we can use its abilities to add caching easy.</p>

<h2>App</h2>

<p>lets imagine we have a simple <code>sinatra</code> app. For purpose of this post we will have app with one method <code>/ohhai</code> that shows current time. This is a great way to test if out caching is working fine. Code of the app is really simple:</p>

<figure class='code'><figcaption><span>app.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ExampleStaleApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">get</span> <span class="s2">&quot;/ohhai&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'>    <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also to start it easy i have created a config.ru <code>rackup</code> file describing how to start app (in repo there is start.sh script ;)</p>

<figure class='code'><figcaption><span>config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;bundler&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Bundler</span><span class="o">.</span><span class="n">require</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;./app&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">run</span> <span class="no">ExampleStaleApp</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you are using code from my repo <a href="https://github.com/JakubOboza/003-nginx-cache-stale-example">https://github.com/JakubOboza/003-nginx-cache-stale-example</a> to start it all you need to do is</p>

<figure class='code'><figcaption><span>config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">λ</span> <span class="n">git</span> <span class="nb">clone</span> <span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="no">JakubOboza</span><span class="o">/</span><span class="mo">003</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="n">stale</span><span class="o">-</span><span class="n">example</span>
</span><span class='line'><span class="err">λ</span> <span class="n">cd</span> <span class="mo">003</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="n">stale</span><span class="o">-</span><span class="n">example</span>
</span><span class='line'><span class="err">λ</span> <span class="n">bundle</span> <span class="n">install</span>
</span><span class='line'><span class="err">λ</span> <span class="o">.</span><span class="n">/start</span><span class="o">.</span><span class="n">sh</span>
</span></code></pre></td></tr></table></div></figure>


<p>
I configured the app with my own path/uri and to look for upstream server on port 6677 so you need to change it if you are using different settings.</p>

<h1>Caching</h1>

<p> Our app is running now. Lets add caching, for this we will need to add nginx frontend config. In most cases i create a single nginx config for each server in sites-available directory and symlink it in sites-enabled (like apache do by default). I like this setting, it helps a lot to maintain more then one site which is common in development environment and also common on shared applications servers.</p>

<h2>Nginx config file</h2>

<p>I will show complete nginx config file for this example and explain each bit one by one.</p>

<figure class='code'><figcaption><span>nginx.example.caching.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='nginx'><span class='line'><span class="k">upstream</span> <span class="s">sinatra_rackup</span><span class="p">{</span>
</span><span class='line'>  <span class="kn">server</span> <span class="n">0.0.0.0</span><span class="p">:</span><span class="mi">6677</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">proxy_cache_path</span>  <span class="s">/tmp/cache</span> <span class="s">levels=1:2</span> <span class="s">keys_zone=my-test-cache:8m</span> <span class="s">max_size=5000m</span> <span class="s">inactive=300m</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">server</span> <span class="p">{</span>
</span><span class='line'>    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span><span class='line'>    <span class="kn">server_name</span> <span class="s">example_stale.local</span><span class="p">;</span>
</span><span class='line'>    <span class="kn">root</span> <span class="s">/Users/kuba/Workspace/Ruby/example_stale/public</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">access_log</span>  <span class="s">/var/log/nginx/example.stale.access.log</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">proxy_cache</span> <span class="s">my-test-cache</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">proxy_cache_valid</span>  <span class="mi">200</span> <span class="mi">302</span>  <span class="mi">1m</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">proxy_cache_valid</span>  <span class="mi">404</span>      <span class="mi">60m</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">proxy_cache_use_stale</span>   <span class="s">error</span> <span class="s">timeout</span> <span class="s">invalid_header</span> <span class="s">updating</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">proxy_redirect</span> <span class="no">off</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="kn">if</span> <span class="s">(-f</span> <span class="nv">$request_filename/index.html</span><span class="s">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kn">rewrite</span> <span class="s">(.*)</span> <span class="nv">$1/index.html</span> <span class="s">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="kn">if</span> <span class="s">(-f</span> <span class="nv">$request_filename.html</span><span class="s">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kn">rewrite</span> <span class="s">(.*)</span> <span class="nv">$1.html</span> <span class="s">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="kn">if</span> <span class="s">(!-f</span> <span class="nv">$request_filename</span><span class="s">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kn">proxy_pass</span> <span class="s">http://sinatra_rackup</span><span class="p">;</span>
</span><span class='line'>        <span class="kn">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">error_page</span> <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span> <span class="s">/50x.html</span><span class="p">;</span>
</span><span class='line'>    <span class="kn">location</span> <span class="p">=</span> <span class="s">/50x.html</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">root</span> <span class="s">html</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It isn&#8217;t even so long ;)</p>

<h3>upstream</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='nginx'><span class='line'><span class="k">upstream</span> <span class="s">sinatra_rackup</span><span class="p">{</span>
</span><span class='line'>  <span class="kn">server</span> <span class="n">0.0.0.0</span><span class="p">:</span><span class="mi">6677</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>in this part we create description of our upstream. In other words where our application server will be listening. It is easy to just use port but you can configure it to use unix.socket if you want to gain on performance.</p>

<h3>global cache config</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='nginx'><span class='line'><span class="k">proxy_cache_path</span>  <span class="s">/tmp/cache</span> <span class="s">levels=1:2</span> <span class="s">keys_zone=my-test-cache:8m</span> <span class="s">max_size=5000m</span> <span class="s">inactive=300m</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This directive sets the place where cache is stored and sets the zone name and how big it can be. We will refer tot his zone later on in proxy pass cache config.</p>

<h3>app cache config</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='nginx'><span class='line'><span class="k">server</span> <span class="p">{</span>
</span><span class='line'>    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span><span class='line'>    <span class="kn">server_name</span> <span class="s">example_stale.local</span><span class="p">;</span>
</span><span class='line'>    <span class="kn">root</span> <span class="s">/Users/kuba/Workspace/Ruby/example_stale/public</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">proxy_cache</span> <span class="s">my-test-cache</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">proxy_cache_valid</span>  <span class="mi">200</span> <span class="mi">302</span>  <span class="mi">1m</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">proxy_cache_valid</span>  <span class="mi">404</span>      <span class="mi">60m</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">proxy_cache_use_stale</span>   <span class="s">error</span> <span class="s">timeout</span> <span class="s">invalid_header</span> <span class="s">updating</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">proxy_redirect</span> <span class="no">off</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="kn">proxy_pass</span> <span class="s">http://sinatra_rackup</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we configure server name for out application, port to listen on for it and root directory (this is fixed with my mac so you should change it). Whole magic happens in location description. here you have few important things for us.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='nginx'><span class='line'><span class="k">proxy_cache</span> <span class="s">my-test-cache</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sets which cache zone we will use. We use same cache zone we defined in <code>proxy_cache_path</code> with keys_zone.
Next we are setting for how long it should be cached. I used 1 minute for 200 and 302 status. this lets us see on our example app how this works each minute we see new time :). This is awesome! Next you can set different caching time expiry for other status. Here we are refreshing 404 status cache each hour (it could be days :) ).</p>

<p>Last but not the least is serving stale content if upstream is dead.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='nginx'><span class='line'><span class="k">proxy_cache_use_stale</span> <span class="s">error</span> <span class="s">timeout</span> <span class="s">invalid_header</span> <span class="s">updating</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This sets up for us config that will enable serving stale content if upstream is dead. This is nice if you want to provide some content in case when your backend is dead.</p>

<h1>Test</h1>

<p>You can test it now. Or wait&#8230; with my config you have to add entry to <code>/etc/hosts</code></p>

<figure class='code'><figcaption><span>hosts</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>127.0.0.1 example_stale.local
</span></code></pre></td></tr></table></div></figure>


<p>Now you can go to <code>example_stale.local/ohhai</code> (or just <code>curl example_stale.local/ohhai</code>) and see how our cache works. Even more now you can kill your app server and still see cache being served correctly.</p>

<h2>Results</h2>

<p>First request
<img src="http://img820.imageshack.us/img820/1484/screenshot20120331at211.png" alt="10 sec before" />
Next requests
<img src="http://img4.imageshack.us/img4/1484/screenshot20120331at211.png" alt="few ms after" /></p>

<p>-> <a href="http://www.youtube.com/watch?v=lgoXUzIwXk0">http://www.youtube.com/watch?v=lgoXUzIwXk0</a></p>

<h1>Cheers</h1>

<p>How you can use it? Depends on your app architecture, but for every bit of content that you create which is &#8220;static&#8221; it is great thing to have. I like this feature of nginx and i hope this post will help you ;).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/29/rebar-swiss-army-knife/">Rebar -> Swiss Army Knife</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-29T18:55:00+01:00" pubdate data-updated="true">Mar 29<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/03/29/rebar-swiss-army-knife/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Intro</h1>

<p>Rebar is a great command line tool for building your Erlang apps. It was developed by guys from <code>basho</code> <a href="http://basho.com/">http://basho.com/</a>. If you want to build Erlang app or module you can skip a lot of config / boilerplate code but using rebar.</p>

<h1>Wait what? How do i get it ?</h1>

<p>To obtain rebar all you have to do is clone source using</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ git clone git://github.com/basho/rebar.git
</span></code></pre></td></tr></table></div></figure>


<p>after obtaining source go into directory and bootstrap it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ <span class="nb">cd </span>rebar
</span><span class='line'>λ ./bootstrap
</span></code></pre></td></tr></table></div></figure>


<p>This will build rebar script if everything is successful. Last thing i suggest is adding this directory to your path.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/path/to/rebar:<span class="nv">$PATH</span>
</span></code></pre></td></tr></table></div></figure>


<p>So you will be able to use it like other command lines tools from &#8220;global namespace&#8221;.
Now you should have working rebar installation. Just to test that everything is ok you can run <code>rebar</code> like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ rebar
</span><span class='line'>No <span class="nb">command </span>to run specified!
</span><span class='line'>Usage: rebar <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-c<span class="o">]</span> <span class="o">[</span>-v &lt;verbose&gt;<span class="o">]</span> <span class="o">[</span>-V<span class="o">]</span> <span class="o">[</span>-f<span class="o">]</span> <span class="o">[</span>-D &lt;defines&gt;<span class="o">]</span> <span class="o">[</span>-j &lt;<span class="nb">jobs</span>&gt;<span class="o">]</span> <span class="o">[</span>-C &lt;config&gt;<span class="o">]</span> <span class="o">[</span>-p<span class="o">]</span> <span class="o">[</span><span class="nv">var</span><span class="o">=</span>value,...<span class="o">]</span> &lt;<span class="nb">command</span>,...&gt;
</span><span class='line'>
</span><span class='line'>  -h, --help      Show the program options
</span><span class='line'>  -c, --commands  Show available commands
</span><span class='line'>  -v, --verbose       Verbosity level <span class="o">(</span>-v, -vv, -vvv, --verbose 3<span class="o">)</span>. Default: 0
</span><span class='line'>  -V, --version       Show version information
</span><span class='line'>  -f, --force     Force
</span><span class='line'>  -D          Define compiler macro
</span><span class='line'>  -j, --jobs      Number of concurrent workers a <span class="nb">command </span>may use. Default: 3
</span><span class='line'>  -C, --config        Rebar config file to use
</span><span class='line'>  -p, --profile       Profile this run of rebar
</span><span class='line'>  <span class="nv">var</span><span class="o">=</span>value        rebar global variables <span class="o">(</span>e.g. <span class="nv">force</span><span class="o">=</span>1<span class="o">)</span>
</span><span class='line'>  <span class="nb">command        </span>Command to run <span class="o">(</span>e.g. compile<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h1>How do i use it @_@ ?</h1>

<p>Two most important things you can generate using <code>rebar</code> are applications and nodes.
To generate application you just need to create app directory and run <code>rebar create-app</code> command like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir furby
</span><span class='line'>λ <span class="nb">cd </span>furby
</span><span class='line'>λ rebar create-app <span class="nv">appid</span><span class="o">=</span><span class="nv">furby</span>
</span><span class='line'><span class="o">==</span>&gt; furby <span class="o">(</span>create-app<span class="o">)</span>
</span><span class='line'>Writing src/furby.app.src
</span><span class='line'>Writing src/furby_app.erl
</span><span class='line'>Writing src/furby_sup.erl
</span></code></pre></td></tr></table></div></figure>


<p>This has created application scaffold with ready to go supervisor. This is ready to go!
to compile it just run <code>rebar compile</code></p>

<h1>Me gusta</h1>

<p>This is all fine but that don&#8217;t eliminate a lot, sweet things are behind the corner :).</p>

<h3>eunit</h3>

<p>Rebar enables you to use easy eunit testing framework within your code. Like we did it here <a href="http://no-fucking-idea.com/blog/2012/03/23/using-eredis-in-erlang/">http://no-fucking-idea.com/blog/2012/03/23/using-eredis-in-erlang/</a>. To do it just run <code>rebar compile eunit</code> .</p>

<figure class='code'><figcaption><span>exmaple_output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ rebar compile eunit
</span><span class='line'>zsh: correct <span class="s1">&#39;eunit&#39;</span> to <span class="s1">&#39;.eunit&#39;</span> <span class="o">[</span>nyae<span class="o">]</span>? <span class="nv">n</span>
</span><span class='line'><span class="o">==</span>&gt; eredis <span class="o">(</span>compile<span class="o">)</span>
</span><span class='line'><span class="o">==</span>&gt; example_db <span class="o">(</span>compile<span class="o">)</span>
</span><span class='line'><span class="o">==</span>&gt; eredis <span class="o">(</span>eunit<span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span>ERROR <span class="nv">REPORT</span><span class="o">====</span> 29-Mar-2012::19:13:21 <span class="o">===</span>
</span><span class='line'>** Generic server &lt;0.259.0&gt; terminating
</span><span class='line'>** Last message in was <span class="o">{</span>tcp,#Port&lt;0.4549&gt;,
</span><span class='line'>                            &lt;&lt;<span class="s2">&quot;*3\r\n$7\r\nmessage\r\n$3\r\nfoo\r\n$2\r\n12\r\n&quot;</span>&gt;&gt;<span class="o">}</span>
</span><span class='line'>** When Server <span class="nv">state</span> <span class="o">==</span> <span class="o">{</span>state,<span class="s2">&quot;127.0.0.1&quot;</span>,6379,&lt;&lt;&gt;&gt;,100,#Port&lt;0.4549&gt;,
</span><span class='line'>                               <span class="o">{</span>pstate,undefined,undefined<span class="o">}</span>,
</span><span class='line'>                               <span class="o">[</span>&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;<span class="o">]</span>,
</span><span class='line'>                               <span class="o">{</span><span class="c">#Ref&lt;0.0.0.3990&gt;,&lt;0.176.0&gt;},</span>
</span><span class='line'>                               <span class="o">{[{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;11&quot;</span>&gt;&gt;,&lt;0.259.0&gt;<span class="o">}</span>,
</span><span class='line'>                                 <span class="o">{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;10&quot;</span>&gt;&gt;,&lt;0.259.0&gt;<span class="o">}</span>,
</span><span class='line'>                                 <span class="o">{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;9&quot;</span>&gt;&gt;,&lt;0.259.0&gt;<span class="o">}</span>,
</span><span class='line'>                                 <span class="o">{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;8&quot;</span>&gt;&gt;,&lt;0.259.0&gt;<span class="o">}</span>,
</span><span class='line'>                                 <span class="o">{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;7&quot;</span>&gt;&gt;,&lt;0.259.0&gt;<span class="o">}</span>,
</span><span class='line'>                                 <span class="o">{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;6&quot;</span>&gt;&gt;,&lt;0.259.0&gt;<span class="o">}</span>,
</span><span class='line'>                                 <span class="o">{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;5&quot;</span>&gt;&gt;,&lt;0.259.0&gt;<span class="o">}</span>,
</span><span class='line'>                                 <span class="o">{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;4&quot;</span>&gt;&gt;,&lt;0.259.0&gt;<span class="o">}</span>,
</span><span class='line'>                                 <span class="o">{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;3&quot;</span>&gt;&gt;,&lt;0.259.0&gt;<span class="o">}]</span>,
</span><span class='line'>                                <span class="o">[{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;2&quot;</span>&gt;&gt;,&lt;0.259.0&gt;<span class="o">}]}</span>,
</span><span class='line'>                               10,exit,need_ack<span class="o">}</span>
</span><span class='line'>** Reason <span class="k">for </span><span class="nv">termination</span> <span class="o">==</span>
</span><span class='line'>** max_queue_size
</span><span class='line'>  All 53 tests passed.
</span><span class='line'>Cover analysis: /private/tmp/example_db/deps/eredis/.eunit/index.html
</span><span class='line'><span class="o">==</span>&gt; example_db <span class="o">(</span>eunit<span class="o">)</span>
</span><span class='line'>  All 3 tests passed.
</span><span class='line'>Cover analysis: /private/tmp/example_db/.eunit/index.html
</span></code></pre></td></tr></table></div></figure>


<h3>coverage</h3>

<p>Also if you will fiddle with <code>rebar.config</code> and set some variables like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ cat rebar.config
</span><span class='line'>%%-*- mode: erlang -*-
</span><span class='line'>
</span><span class='line'><span class="o">{</span>erl_opts, <span class="o">[]}</span>.
</span><span class='line'><span class="o">{</span>cover_enabled, <span class="nb">true</span><span class="o">}</span>.
</span></code></pre></td></tr></table></div></figure>


<p>you can get test coverage generated in <code>.eunit</code> folder. but this is just the beginning.  lets look at it.</p>

<figure class='code'><figcaption><span>example_db.COVER.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>example_db/.eunit λ cat example_db.COVER.html
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;&lt;title&gt;</span>.eunit/example_db.COVER.html<span class="nt">&lt;/title&gt;&lt;/head&gt;&lt;body</span> <span class="na">bgcolor=</span><span class="s">white</span> <span class="na">text=</span><span class="s">black</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;pre&gt;</span>
</span><span class='line'>File generated from /private/tmp/example_db/.eunit/example_db.erl by COVER 2012-03-29 at 19:13:21
</span><span class='line'>
</span><span class='line'>****************************************************************************
</span><span class='line'>
</span><span class='line'>        |  -module(example_db).
</span><span class='line'>        |  -behaviour(gen_server).
</span><span class='line'>        |
</span><span class='line'>...(and more)
</span></code></pre></td></tr></table></div></figure>


<h3>dependencies</h3>

<p>Last thing i want to mention is dependencies, i love this feature from <code>rebar</code>. You can add dependencies and rebar will do all the magic for you :). just open your <code>rebar.config</code>  and add thme like this:</p>

<figure class='code'><figcaption><span>rebar.config</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>%%-*- mode: erlang -*-
</span><span class='line'>
</span><span class='line'><span class="o">{</span>erl_opts, <span class="o">[]}</span>.
</span><span class='line'><span class="o">{</span>cover_enabled, <span class="nb">true</span><span class="o">}</span>.
</span><span class='line'>
</span><span class='line'><span class="o">{</span>deps,
</span><span class='line'>  <span class="o">[</span>
</span><span class='line'>    <span class="o">{</span>eredis, <span class="s2">&quot;.*&quot;</span>, <span class="o">{</span>git, <span class="s2">&quot;https://github.com/wooga/eredis.git&quot;</span>, <span class="s2">&quot;HEAD&quot;</span><span class="o">}}</span>
</span><span class='line'>  <span class="o">]</span>
</span><span class='line'><span class="o">}</span>.
</span></code></pre></td></tr></table></div></figure>


<p>Whenever you will type <code>rebar get-deps</code> he will download all dependencies and install them into <code>deps</code> directory. This makes developing applications using things like mochiweb really easy!</p>

<h1>Summary</h1>

<p>I love this tool, it makes learning and development in <code>Erlang</code> much easier and more rewarding experience. I hope this help you a bit :). Cheers!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/23/using-eredis-in-erlang/">Using Eredis, Redis With Erlang</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-23T23:28:00+00:00" pubdate data-updated="true">Mar 23<span>rd</span>, 2012</time>
        
         | <a href="/blog/2012/03/23/using-eredis-in-erlang/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently i decided to move my blog from <code>tumblr.com</code> to <code>octopress engine</code> because it is just easier for me to maintain it and it looks nicer. The old blog is under <a href="http://no-fucking-idea.tumblr.com">http://no-fucking-idea.tumblr.com</a>. My first post on new blog is dedicated to using redis with erlang.</p>

<h1>Eredis</h1>

<p>Wooga created a really nice (performance driven) redis driver for erlang. You can get it here <a href="https://github.com/wooga/eredis">https://github.com/wooga/eredis</a>. It is really easy and nice.</p>

<h1>Initial sample</h1>

<p>On project page you can find simple examples how to use eredis. Examples there are all you need (but i need something for front page of my new blog so i will rewrite them and explain them :) ).</p>

<h2>First you need to start your eredis application</h2>

<figure class='code'><figcaption><span>initialization</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Client</span><span class="p">}</span> <span class="o">=</span> <span class="nn">eredis</span><span class="p">:</span><span class="n">start_link</span><span class="p">().</span>
</span></code></pre></td></tr></table></div></figure>


<p>
Client is the &#8220;connection / state&#8221; we will be using with rest of queries.</p>

<p>To query things with redis we will use <code>q</code> method from eredis module which takes &#8220;Connection / Client&#8221; state and list with params.
This api is very simple here are two most basic examples of get and set.
GET:</p>

<figure class='code'><figcaption><span>get</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;OK&quot;</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="o">=</span> <span class="nn">eredis</span><span class="p">:</span><span class="n">q</span><span class="p">(</span><span class="nv">Client</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;SET&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;kuba&quot;</span><span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure>


<p>and SET:</p>

<figure class='code'><figcaption><span>set</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;kuba&quot;</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="o">=</span> <span class="nn">eredis</span><span class="p">:</span><span class="n">q</span><span class="p">(</span><span class="nv">Client</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure>


<p>From my point of view this is ideal candidate to be turned into gen_server behavior. We will pass &#8220;Connection / Client&#8221; as state and also we will build some &#8220;key&#8221; serialization methods around it to make it more durable and make our life easy if we will decide to refactor it later on.</p>

<h1>Free Api wrapper</h1>

<p>First thing i saw during development using Erlang is that you get free api if you follow simple patterns and encapsulate things into gen_server&#8217;s and applications.</p>

<figure class='code'><figcaption><span>example_db.erl</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">example_db</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">behaviour</span><span class="p">(</span><span class="n">gen_server</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">author</span><span class="p">(</span><span class="s">&quot;jakub.oboza@gmail.com&quot;</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">Prefix</span><span class="p">,</span> <span class="s">&quot;example&quot;</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_link</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_call</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">handle_cast</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">handle_info</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">code_change</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">stop</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">get_script</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">save_script</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="c">% public api</span>
</span><span class='line'>
</span><span class='line'><span class="nf">start_link</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nn">gen_server</span><span class="p">:</span><span class="n">start_link</span><span class="p">({</span><span class="n">local</span><span class="p">,</span> <span class="no">?MODULE</span><span class="p">},</span> <span class="no">?MODULE</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">init</span><span class="p">([])</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Redis</span><span class="p">}</span> <span class="o">=</span> <span class="nn">eredis</span><span class="p">:</span><span class="n">start_link</span><span class="p">(),</span>
</span><span class='line'>  <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Redis</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">stop</span><span class="p">(_</span><span class="nv">Pid</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="n">stop</span><span class="p">().</span>
</span><span class='line'>
</span><span class='line'><span class="nf">stop</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">gen_server</span><span class="p">:</span><span class="n">cast</span><span class="p">(</span><span class="no">?MODULE</span><span class="p">,</span> <span class="n">stop</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="c">%% public client api</span>
</span><span class='line'>
</span><span class='line'><span class="nf">get_script</span><span class="p">(</span><span class="nv">Api</span><span class="p">,</span> <span class="nv">Method</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">(</span><span class="no">?MODULE</span><span class="p">,</span> <span class="p">{</span><span class="n">get_script</span><span class="p">,</span> <span class="nv">Api</span><span class="p">,</span> <span class="nv">Method</span><span class="p">}).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">save_script</span><span class="p">(</span><span class="nv">Api</span><span class="p">,</span> <span class="nv">Method</span><span class="p">,</span> <span class="nv">Script</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">(</span><span class="no">?MODULE</span><span class="p">,</span> <span class="p">{</span><span class="n">save_script</span><span class="p">,</span> <span class="nv">Api</span><span class="p">,</span> <span class="nv">Method</span><span class="p">,</span> <span class="nv">Script</span><span class="p">}).</span>
</span><span class='line'>
</span><span class='line'><span class="c">%% genserver handles</span>
</span><span class='line'>
</span><span class='line'><span class="nf">handle_call</span><span class="p">({</span><span class="n">get_script</span><span class="p">,</span> <span class="nv">Api</span><span class="p">,</span> <span class="nv">Method</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Redis</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nv">Response</span> <span class="o">=</span> <span class="nn">eredis</span><span class="p">:</span><span class="n">q</span><span class="p">(</span><span class="nv">Redis</span><span class="p">,</span> <span class="p">[</span> <span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="n">get_key</span><span class="p">(</span><span class="nv">Api</span><span class="p">,</span> <span class="nv">Method</span><span class="p">)</span> <span class="p">]),</span>
</span><span class='line'>  <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Response</span><span class="p">,</span> <span class="nv">Redis</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nf">handle_call</span><span class="p">({</span><span class="n">save_script</span><span class="p">,</span> <span class="nv">Api</span><span class="p">,</span> <span class="nv">Method</span><span class="p">,</span> <span class="nv">Script</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Redis</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nv">Response</span> <span class="o">=</span> <span class="nn">eredis</span><span class="p">:</span><span class="n">q</span><span class="p">(</span><span class="nv">Redis</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;SET&quot;</span><span class="p">,</span> <span class="n">get_key</span><span class="p">(</span><span class="nv">Api</span><span class="p">,</span> <span class="nv">Method</span><span class="p">),</span> <span class="nv">Script</span><span class="p">]),</span>
</span><span class='line'>  <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Response</span><span class="p">,</span> <span class="nv">Redis</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nf">handle_call</span><span class="p">(_</span><span class="nv">Message</span><span class="p">,</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Redis</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="nv">Redis</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">handle_cast</span><span class="p">(_</span><span class="nv">Message</span><span class="p">,</span> <span class="nv">Redis</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">Redis</span><span class="p">}.</span>
</span><span class='line'><span class="nf">handle_info</span><span class="p">(_</span><span class="nv">Message</span><span class="p">,</span> <span class="nv">Redis</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">Redis</span><span class="p">}.</span>
</span><span class='line'><span class="nf">terminate</span><span class="p">(_</span><span class="nv">Reason</span><span class="p">,</span> <span class="p">_</span><span class="nv">Redis</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ok</span><span class="p">.</span>
</span><span class='line'><span class="nf">code_change</span><span class="p">(_</span><span class="nv">OldVersion</span><span class="p">,</span> <span class="nv">Redis</span><span class="p">,</span> <span class="p">_</span><span class="nv">Extra</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Redis</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="c">%% helper methods</span>
</span><span class='line'>
</span><span class='line'><span class="nf">get_key</span><span class="p">(</span><span class="nv">Api</span><span class="p">,</span> <span class="nv">Method</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="n">generate_key</span><span class="p">([</span><span class="nv">Api</span><span class="p">,</span> <span class="nv">Method</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">generate_key</span><span class="p">(</span><span class="nv">KeysList</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nn">lists</span><span class="p">:</span><span class="n">foldl</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Acc</span> <span class="o">++</span> <span class="s">&quot;:&quot;</span> <span class="o">++</span> <span class="nv">Key</span> <span class="k">end</span><span class="p">,</span> <span class="no">?Prefix</span><span class="p">,</span> <span class="nv">KeysList</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="c">% tests</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">ifdef</span><span class="p">(</span><span class="nv">TEST</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">include_lib</span><span class="p">(</span><span class="s">&quot;eunit/include/eunit.hrl&quot;</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">endif</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">ifdef</span><span class="p">(</span><span class="nv">TEST</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">generate_key_test</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nv">Key</span> <span class="o">=</span> <span class="n">generate_key</span><span class="p">([</span><span class="s">&quot;one&quot;</span><span class="p">,</span> <span class="s">&quot;two&quot;</span><span class="p">,</span> <span class="s">&quot;three&quot;</span><span class="p">]),</span>
</span><span class='line'>  <span class="no">?assertEqual</span><span class="p">(</span><span class="s">&quot;example:one:two:three&quot;</span><span class="p">,</span> <span class="nv">Key</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">server_test_</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="p">{</span><span class="n">setup</span><span class="p">,</span> <span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">example_db</span><span class="p">:</span><span class="n">start_link</span><span class="p">()</span> <span class="k">end</span><span class="p">,</span>
</span><span class='line'>   <span class="k">fun</span><span class="p">(_</span><span class="nv">Pid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">example_db</span><span class="p">:</span><span class="n">stop</span><span class="p">(_</span><span class="nv">Pid</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
</span><span class='line'>   <span class="k">fun</span> <span class="n">generate_example_db_tests</span><span class="o">/</span><span class="mi">1</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">generate_example_db_tests</span><span class="p">(_</span><span class="nv">Pid</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="p">[</span>
</span><span class='line'>    <span class="no">?_assertEqual</span><span class="p">({</span><span class="n">ok</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;OK&quot;</span><span class="o">&gt;&gt;</span><span class="p">},</span> <span class="nn">example_db</span><span class="p">:</span><span class="n">save_script</span><span class="p">(</span><span class="s">&quot;jakub&quot;</span><span class="p">,</span> <span class="s">&quot;oboza&quot;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;yo dwang&quot;</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="p">),</span>
</span><span class='line'>    <span class="no">?_assertEqual</span><span class="p">({</span><span class="n">ok</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;yo dwang&quot;</span><span class="o">&gt;&gt;</span><span class="p">},</span> <span class="nn">example_db</span><span class="p">:</span><span class="n">get_script</span><span class="p">(</span><span class="s">&quot;jakub&quot;</span><span class="p">,</span> <span class="s">&quot;oboza&quot;</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">].</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">endif</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Public Api</h2>

<p>This code listing has two important parts first at top it starts at line 26.
This is the public API which will be used by developer. This is this free api. Later on i will explain how to change redis to mongodb and probably to other db engines without doing changes in rest of our app. From my perspective this is awesome feature.
In most cases when i had to make app scale problem of having code that was glues to one db engine was heavy.</p>

<h2>eunit tests</h2>

<p>At line 60. starts the declaration of tests, using <code>rebar</code> and <code>eunit</code> is very easy and it is always good to have test coverage in case of refactoring. I&#8217;m a fan of test driven development so i like to cover in tests first things that i will use or i think they might be error prone. Here is used &#8220;test generators&#8221; to just to show how to write tests for gen_server.</p>

<h1>Rebar</h1>

<p>Before i will explain more i need to say little about <code>rebar</code>. It is a command line tool that was developed by <code>basho</code> to help create app. it is by far the best thing i found learning erlang to help me do boring stuff and eliminate a lot of rage writing <code>app.src</code> files. To get rebar simply do (you can always go to <a href="https://github.com/basho/rebar">https://github.com/basho/rebar</a> to get most up to date informations about building it)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ  git clone git://github.com/basho/rebar.git
</span><span class='line'>λ  <span class="nb">cd </span>rebar
</span><span class='line'>λ  ./bootstrap
</span></code></pre></td></tr></table></div></figure>


<p>I use my own set of zsh scripts so all i did to add it to my path was to edit <code>.furby</code> file in my home dir. I strongly suggest also adding it to <code>$PATH</code> just to make your life easier.</p>

<h1>Back to example_db!</h1>

<p>To create app using rebar you just need to</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ mkdir example_db
</span><span class='line'>λ rebar create-app <span class="nv">appid</span><span class="o">=</span><span class="nv">example_db</span>
</span><span class='line'><span class="o">==</span>&gt; example_db <span class="o">(</span>create-app<span class="o">)</span>
</span><span class='line'>Writing src/example_db.app.src
</span><span class='line'>Writing src/example_db_app.erl
</span><span class='line'>Writing src/example_db_sup.erl
</span></code></pre></td></tr></table></div></figure>


<p>This command created <code>src</code> folder with scaffold of <code>application</code> OTP pattern and <code>supervisor</code> thats almost all we need :).
Now you can compile it using <code>rebar compile</code> and run tests using <code>rebar compile eunit</code> in out app currently we will see</p>

<figure class='code'><figcaption><span>rebar compile eunit</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ rebar compile <span class="nv">eunit</span>
</span><span class='line'><span class="o">==</span>&gt; example_db <span class="o">(</span>compile<span class="o">)</span>
</span><span class='line'>Compiled src/example_db_app.erl
</span><span class='line'>Compiled src/example_db_sup.erl
</span><span class='line'><span class="o">==</span>&gt; example_db <span class="o">(</span>eunit<span class="o">)</span>
</span><span class='line'>Compiled src/example_db_app.erl
</span><span class='line'>Compiled src/example_db_sup.erl
</span><span class='line'>  There were no tests to run.
</span></code></pre></td></tr></table></div></figure>


<p>Nothing to do because its empty. Lets add our db module.
But before this we need to add dependencies for eredis module. Lets create <code>rebar.config</code> file and add it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ emacs rebar.config
</span><span class='line'>λ cat rebar.config
</span><span class='line'>%%-*- mode: erlang -*-
</span><span class='line'>
</span><span class='line'><span class="o">{</span>erl_opts, <span class="o">[]}</span>.
</span><span class='line'><span class="o">{</span>cover_enabled, <span class="nb">true</span><span class="o">}</span>.
</span><span class='line'>
</span><span class='line'><span class="o">{</span>deps,
</span><span class='line'>  <span class="o">[</span>
</span><span class='line'>    <span class="o">{</span>eredis, <span class="s2">&quot;.*&quot;</span>, <span class="o">{</span>git, <span class="s2">&quot;https://github.com/wooga/eredis.git&quot;</span>, <span class="s2">&quot;HEAD&quot;</span><span class="o">}}</span>
</span><span class='line'>  <span class="o">]</span>
</span><span class='line'><span class="o">}</span>.
</span></code></pre></td></tr></table></div></figure>


<p>Now just run <code>rebar get-deps</code> to get all dependencies downloaded.
After adding our <code>example_db.erl</code> into <code>src</code> directory we can run <code>rebar compile eunit</code> to compile and run tests. We have added <code>{cover_enabled, true}</code> in rebar.conf so also test code coverage will be generated for us.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ rebar compile <span class="nv">eunit</span>
</span><span class='line'><span class="o">==</span>&gt; eredis <span class="o">(</span>compile<span class="o">)</span>
</span><span class='line'><span class="o">==</span>&gt; example_db <span class="o">(</span>compile<span class="o">)</span>
</span><span class='line'>Compiled src/example_db.erl
</span><span class='line'><span class="o">==</span>&gt; eredis <span class="o">(</span>eunit<span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span>ERROR <span class="nv">REPORT</span><span class="o">====</span> 28-Mar-2012::22:19:35 <span class="o">===</span>
</span><span class='line'>** Generic server &lt;0.263.0&gt; terminating
</span><span class='line'>** Last message in was <span class="o">{</span>tcp,#Port&lt;0.4516&gt;,
</span><span class='line'>                            &lt;&lt;<span class="s2">&quot;*3\r\n$7\r\nmessage\r\n$3\r\nfoo\r\n$2\r\n12\r\n&quot;</span>&gt;&gt;<span class="o">}</span>
</span><span class='line'>** When Server <span class="nv">state</span> <span class="o">==</span> <span class="o">{</span>state,<span class="s2">&quot;127.0.0.1&quot;</span>,6379,&lt;&lt;&gt;&gt;,100,#Port&lt;0.4516&gt;,
</span><span class='line'>                               <span class="o">{</span>pstate,undefined,undefined<span class="o">}</span>,
</span><span class='line'>                               <span class="o">[</span>&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;<span class="o">]</span>,
</span><span class='line'>                               <span class="o">{</span><span class="c">#Ref&lt;0.0.0.4058&gt;,&lt;0.180.0&gt;},</span>
</span><span class='line'>                               <span class="o">{[{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;11&quot;</span>&gt;&gt;,&lt;0.263.0&gt;<span class="o">}</span>,
</span><span class='line'>                                 <span class="o">{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;10&quot;</span>&gt;&gt;,&lt;0.263.0&gt;<span class="o">}</span>,
</span><span class='line'>                                 <span class="o">{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;9&quot;</span>&gt;&gt;,&lt;0.263.0&gt;<span class="o">}</span>,
</span><span class='line'>                                 <span class="o">{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;8&quot;</span>&gt;&gt;,&lt;0.263.0&gt;<span class="o">}</span>,
</span><span class='line'>                                 <span class="o">{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;7&quot;</span>&gt;&gt;,&lt;0.263.0&gt;<span class="o">}</span>,
</span><span class='line'>                                 <span class="o">{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;6&quot;</span>&gt;&gt;,&lt;0.263.0&gt;<span class="o">}</span>,
</span><span class='line'>                                 <span class="o">{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;5&quot;</span>&gt;&gt;,&lt;0.263.0&gt;<span class="o">}</span>,
</span><span class='line'>                                 <span class="o">{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;4&quot;</span>&gt;&gt;,&lt;0.263.0&gt;<span class="o">}</span>,
</span><span class='line'>                                 <span class="o">{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;3&quot;</span>&gt;&gt;,&lt;0.263.0&gt;<span class="o">}]</span>,
</span><span class='line'>                                <span class="o">[{</span>message,&lt;&lt;<span class="s2">&quot;foo&quot;</span>&gt;&gt;,&lt;&lt;<span class="s2">&quot;2&quot;</span>&gt;&gt;,&lt;0.263.0&gt;<span class="o">}]}</span>,
</span><span class='line'>                               10,exit,need_ack<span class="o">}</span>
</span><span class='line'>** Reason <span class="k">for </span><span class="nv">termination</span> <span class="o">==</span>
</span><span class='line'>** max_queue_size
</span><span class='line'>  All 53 tests passed.
</span><span class='line'>Cover analysis: /private/tmp/example_db/deps/eredis/.eunit/index.html
</span><span class='line'><span class="o">==</span>&gt; example_db <span class="o">(</span>eunit<span class="o">)</span>
</span><span class='line'>Compiled src/example_db.erl
</span><span class='line'>  All 3 tests passed.
</span><span class='line'>Cover analysis: /private/tmp/example_db/.eunit/index.html
</span></code></pre></td></tr></table></div></figure>


<p>All seems to be fine! lets create file called  <code>start.sh</code> to test it out</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>λ cat start.sh
</span><span class='line'>erl -pa ebin -pa deps/*/ebin
</span></code></pre></td></tr></table></div></figure>


<p>and make it executable with <code>chmod +x start.sh</code></p>

<p>And lets rock &#8216;n&#8217; roll</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> λ ./start.sh
</span><span class='line'>Erlang R15B <span class="o">(</span>erts-5.9<span class="o">)</span> <span class="o">[</span><span class="nb">source</span><span class="o">]</span> <span class="o">[</span>64-bit<span class="o">]</span> <span class="o">[</span>smp:4:4<span class="o">]</span> <span class="o">[</span>async-threads:0<span class="o">]</span> <span class="o">[</span>hipe<span class="o">]</span> <span class="o">[</span>kernel-poll:false<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Eshell V5.9  <span class="o">(</span>abort with ^G<span class="o">)</span>
</span><span class='line'>1&gt; example_db:start_link<span class="o">()</span>.
</span><span class='line'><span class="o">{</span>ok,&lt;0.33.0&gt;<span class="o">}</span>
</span><span class='line'>2&gt; example_db:save_script<span class="o">(</span><span class="s2">&quot;example&quot;</span>, <span class="s2">&quot;script&quot;</span>, <span class="s2">&quot;puts &#39;2+2&#39;&quot;</span><span class="o">)</span>.
</span><span class='line'><span class="o">{</span>ok,&lt;&lt;<span class="s2">&quot;OK&quot;</span>&gt;&gt;<span class="o">}</span>
</span><span class='line'>3&gt; example_db:get_script<span class="o">(</span><span class="s2">&quot;example&quot;</span>, <span class="s2">&quot;script&quot;</span><span class="o">)</span>.
</span><span class='line'><span class="o">{</span>ok,&lt;&lt;<span class="s2">&quot;puts &#39;2+2&#39;&quot;</span>&gt;&gt;<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Have fun :) Hope it was useful. You can download code for this blog post here <a href="https://github.com/JakubOboza/example_db-code">https://github.com/JakubOboza/example_db-code</a></p>

<h3>Huh ^___^</h3>

<p>that was my first post on new blog ;)</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/06/09/how-to-use-twitter-for-something-else-than-pics-of-cats/">How to use twitter for something else than pics of cats</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/21/if-the-real-game-changer/">&#8216;if&#8217; the real game changer</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/12/recent-rails-security-problems-and-building-software/">Recent Rails security problems and building software</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/05/building-ffi-extensions-in-erlang/">Building FFI extensions in Erlang</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/22/making-request-to-rest-resources-in-erlang/">Making request to REST resources in Erlang</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/JakubOboza">@JakubOboza</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'JakubOboza',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("JakubOboza", 9000, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/JakubOboza" class="twitter-follow-button" data-show-count="false">Follow @JakubOboza</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/101398174644580064637?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Jakub Oboza -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'nofuckingidea';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
