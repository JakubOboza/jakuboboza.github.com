<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Redis | No F*cking Idea]]></title>
  <link href="http://no-fucking-idea.com/blog/categories/redis/atom.xml" rel="self"/>
  <link href="http://no-fucking-idea.com/"/>
  <updated>2013-12-12T19:35:54+00:00</updated>
  <id>http://no-fucking-idea.com/</id>
  <author>
    <name><![CDATA[Jakub Oboza]]></name>
    <email><![CDATA[jakub.oboza@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Using eredis, redis with erlang]]></title>
    <link href="http://no-fucking-idea.com/blog/2012/03/23/using-eredis-in-erlang/"/>
    <updated>2012-03-23T23:28:00+00:00</updated>
    <id>http://no-fucking-idea.com/blog/2012/03/23/using-eredis-in-erlang</id>
    <content type="html"><![CDATA[<p>Recently i decided to move my blog from <code>tumblr.com</code> to <code>octopress engine</code> because it is just easier for me to maintain it and it looks nicer. The old blog is under <a href="http://no-fucking-idea.tumblr.com">http://no-fucking-idea.tumblr.com</a>. My first post on new blog is dedicated to using redis with erlang.</p>

<h1>Eredis</h1>

<p>Wooga created a really nice (performance driven) redis driver for erlang. You can get it here <a href="https://github.com/wooga/eredis">https://github.com/wooga/eredis</a>. It is really easy and nice.</p>

<h1>Initial sample</h1>

<p>On project page you can find simple examples how to use eredis. Examples there are all you need (but i need something for front page of my new blog so i will rewrite them and explain them :) ).</p>

<h2>First you need to start your eredis application</h2>

<p><code>erlang initialization
{ok, Client} = eredis:start_link().
</code>
Client is the &ldquo;connection / state&rdquo; we will be using with rest of queries.</p>

<p>To query things with redis we will use <code>q</code> method from eredis module which takes &ldquo;Connection / Client&rdquo; state and list with params.
This api is very simple here are two most basic examples of get and set.
GET:
<code>erlang get
{ok, &lt;&lt;"OK"&gt;&gt;} = eredis:q(Client, ["SET", "name", "kuba"]).
</code>
and SET:
<code>erlang set
{ok, &lt;&lt;"kuba"&gt;&gt;} = eredis:q(Client, ["GET", "name"]).
</code>
From my point of view this is ideal candidate to be turned into gen_server behavior. We will pass &ldquo;Connection / Client&rdquo; as state and also we will build some &ldquo;key&rdquo; serialization methods around it to make it more durable and make our life easy if we will decide to refactor it later on.</p>

<h1>Free Api wrapper</h1>

<p>First thing i saw during development using Erlang is that you get free api if you follow simple patterns and encapsulate things into gen_server&rsquo;s and applications.</p>

<p>``` erlang example_db.erl
-module(example_db).
-behaviour(gen_server).</p>

<p>-author(&ldquo;<a href="&#109;&#97;&#x69;&#x6c;&#116;&#111;&#x3a;&#x6a;&#x61;&#x6b;&#x75;&#x62;&#x2e;&#x6f;&#98;&#111;&#122;&#x61;&#64;&#103;&#109;&#x61;&#105;&#x6c;&#x2e;&#99;&#111;&#x6d;">&#106;&#x61;&#107;&#117;&#98;&#x2e;&#x6f;&#98;&#x6f;&#122;&#x61;&#64;&#103;&#109;&#x61;&#x69;&#108;&#x2e;&#x63;&#111;&#x6d;</a>&rdquo;).
-define(Prefix, &ldquo;example&rdquo;).</p>

<p>-export([start_link/0]).
-export([init/1, handle_call/3, handle_cast/2, terminate/2, handle_info/2, code_change/3, stop/1]).
-export([get_script/2, save_script/3]).</p>

<p>% public api</p>

<p>start_link() &ndash;>
  gen_server:start_link({local, ?MODULE}, ?MODULE, [], []).</p>

<p>init([]) &ndash;>
  {ok, Redis} = eredis:start_link(),
  {ok, Redis}.</p>

<p>stop(_Pid) &ndash;>
  stop().</p>

<p>stop() &ndash;></p>

<pre><code>gen_server:cast(?MODULE, stop).
</code></pre>

<p>%% public client api</p>

<p>get_script(Api, Method) &ndash;>
  gen_server:call(?MODULE, {get_script, Api, Method}).</p>

<p>save_script(Api, Method, Script) &ndash;>
  gen_server:call(?MODULE, {save_script, Api, Method, Script}).</p>

<p>%% genserver handles</p>

<p>handle_call({get_script, Api, Method}, _From, Redis) &ndash;>
  Response = eredis:q(Redis, [ &ldquo;GET&rdquo;, get_key(Api, Method) ]),
  {reply, Response, Redis};</p>

<p>handle_call({save_script, Api, Method, Script}, _From, Redis) &ndash;>
  Response = eredis:q(Redis, [&ldquo;SET&rdquo;, get_key(Api, Method), Script]),
  {reply, Response, Redis};</p>

<p>handle_call(<em>Message, </em>From, Redis) &ndash;>
  {reply, error, Redis}.</p>

<p>handle_cast(<em>Message, Redis) &ndash;> {noreply, Redis}.
handle_info(</em>Message, Redis) &ndash;> {noreply, Redis}.
terminate(<em>Reason, </em>Redis) &ndash;> ok.
code_change(<em>OldVersion, Redis, </em>Extra) &ndash;> {ok, Redis}.</p>

<p>%% helper methods</p>

<p>get_key(Api, Method) &ndash;>
  generate_key([Api, Method]).</p>

<p>generate_key(KeysList) &ndash;>
  lists:foldl(fun(Key, Acc) &ndash;> Acc ++ &ldquo;:&rdquo; ++ Key end, ?Prefix, KeysList).</p>

<p>% tests</p>

<p>-ifdef(TEST).
-include_lib(&ldquo;eunit/include/eunit.hrl&rdquo;).
-endif.</p>

<p>-ifdef(TEST).</p>

<p>generate_key_test() &ndash;>
  Key = generate_key([&ldquo;one&rdquo;, &ldquo;two&rdquo;, &ldquo;three&rdquo;]),
  ?assertEqual(&ldquo;example:one:two:three&rdquo;, Key).</p>

<p>server_test<em>() &ndash;>
  {setup, fun() &ndash;> example_db:start_link() end,
   fun(</em>Pid) &ndash;> example_db:stop(_Pid) end,
   fun generate_example_db_tests/1}.</p>

<p>generate_example_db_tests(_Pid) &ndash;>
  [</p>

<pre><code>?_assertEqual({ok,&lt;&lt;"OK"&gt;&gt;}, example_db:save_script("jakub", "oboza", &lt;&lt;"yo dwang"&gt;&gt;) ),
?_assertEqual({ok,&lt;&lt;"yo dwang"&gt;&gt;}, example_db:get_script("jakub", "oboza") )
</code></pre>

<p>  ].</p>

<p>-endif
```</p>

<h2>Public Api</h2>

<p>This code listing has two important parts first at top it starts at line 26.
This is the public API which will be used by developer. This is this free api. Later on i will explain how to change redis to mongodb and probably to other db engines without doing changes in rest of our app. From my perspective this is awesome feature.
In most cases when i had to make app scale problem of having code that was glues to one db engine was heavy.</p>

<h2>eunit tests</h2>

<p>At line 60. starts the declaration of tests, using <code>rebar</code> and <code>eunit</code> is very easy and it is always good to have test coverage in case of refactoring. I&rsquo;m a fan of test driven development so i like to cover in tests first things that i will use or i think they might be error prone. Here is used &ldquo;test generators&rdquo; to just to show how to write tests for gen_server.</p>

<h1>Rebar</h1>

<p>Before i will explain more i need to say little about <code>rebar</code>. It is a command line tool that was developed by <code>basho</code> to help create app. it is by far the best thing i found learning erlang to help me do boring stuff and eliminate a lot of rage writing <code>app.src</code> files. To get rebar simply do (you can always go to <a href="https://github.com/basho/rebar">https://github.com/basho/rebar</a> to get most up to date informations about building it)</p>

<p><code>bash
λ  git clone git://github.com/basho/rebar.git
λ  cd rebar
λ  ./bootstrap
</code></p>

<p>I use my own set of zsh scripts so all i did to add it to my path was to edit <code>.furby</code> file in my home dir. I strongly suggest also adding it to <code>$PATH</code> just to make your life easier.</p>

<h1>Back to example_db!</h1>

<p>To create app using rebar you just need to
<code>bash
λ mkdir example_db
λ rebar create-app appid=example_db
==&gt; example_db (create-app)
Writing src/example_db.app.src
Writing src/example_db_app.erl
Writing src/example_db_sup.erl
</code>
This command created <code>src</code> folder with scaffold of <code>application</code> OTP pattern and <code>supervisor</code> thats almost all we need :).
Now you can compile it using <code>rebar compile</code> and run tests using <code>rebar compile eunit</code> in out app currently we will see
<code>bash rebar compile eunit
λ rebar compile eunit
==&gt; example_db (compile)
Compiled src/example_db_app.erl
Compiled src/example_db_sup.erl
==&gt; example_db (eunit)
Compiled src/example_db_app.erl
Compiled src/example_db_sup.erl
  There were no tests to run.
</code>
Nothing to do because its empty. Lets add our db module.
But before this we need to add dependencies for eredis module. Lets create <code>rebar.config</code> file and add it.
``` bash
λ emacs rebar.config
λ cat rebar.config
%%&ndash;<em>&ndash; mode: erlang &ndash;</em>&ndash;</p>

<p>{erl_opts, []}.
{cover_enabled, true}.</p>

<p>{deps,
  [</p>

<pre><code>{eredis, ".*", {git, "https://github.com/wooga/eredis.git", "HEAD"}}
</code></pre>

<p>  ]
}.
<code>
Now just run `rebar get-deps` to get all dependencies downloaded.
After adding our `example_db.erl` into `src` directory we can run `rebar compile eunit` to compile and run tests. We have added `{cover_enabled, true}` in rebar.conf so also test code coverage will be generated for us.
</code> bash
λ rebar compile eunit
==> eredis (compile)
==> example_db (compile)
Compiled src/example_db.erl
==> eredis (eunit)</p>

<p>=ERROR REPORT==== 28-Mar-2012::22:19:35 ===
<strong> Generic server &lt;0.263.0> terminating
</strong> Last message in was {tcp,#Port&lt;0.4516>,</p>

<pre><code>                        &lt;&lt;"*3\r\n$7\r\nmessage\r\n$3\r\nfoo\r\n$2\r\n12\r\n"&gt;&gt;}
</code></pre>

<p>** When Server state == {state,&ldquo;127.0.0.1&rdquo;,6379,&lt;&lt;>>,100,#Port&lt;0.4516>,</p>

<pre><code>                           {pstate,undefined,undefined},
                           [&lt;&lt;"foo"&gt;&gt;],
                           {#Ref&lt;0.0.0.4058&gt;,&lt;0.180.0&gt;},
                           {[{message,&lt;&lt;"foo"&gt;&gt;,&lt;&lt;"11"&gt;&gt;,&lt;0.263.0&gt;},
                             {message,&lt;&lt;"foo"&gt;&gt;,&lt;&lt;"10"&gt;&gt;,&lt;0.263.0&gt;},
                             {message,&lt;&lt;"foo"&gt;&gt;,&lt;&lt;"9"&gt;&gt;,&lt;0.263.0&gt;},
                             {message,&lt;&lt;"foo"&gt;&gt;,&lt;&lt;"8"&gt;&gt;,&lt;0.263.0&gt;},
                             {message,&lt;&lt;"foo"&gt;&gt;,&lt;&lt;"7"&gt;&gt;,&lt;0.263.0&gt;},
                             {message,&lt;&lt;"foo"&gt;&gt;,&lt;&lt;"6"&gt;&gt;,&lt;0.263.0&gt;},
                             {message,&lt;&lt;"foo"&gt;&gt;,&lt;&lt;"5"&gt;&gt;,&lt;0.263.0&gt;},
                             {message,&lt;&lt;"foo"&gt;&gt;,&lt;&lt;"4"&gt;&gt;,&lt;0.263.0&gt;},
                             {message,&lt;&lt;"foo"&gt;&gt;,&lt;&lt;"3"&gt;&gt;,&lt;0.263.0&gt;}],
                            [{message,&lt;&lt;"foo"&gt;&gt;,&lt;&lt;"2"&gt;&gt;,&lt;0.263.0&gt;}]},
                           10,exit,need_ack}
</code></pre>

<p><strong> Reason for termination ==
</strong> max_queue_size
  All 53 tests passed.
Cover analysis: /private/tmp/example_db/deps/eredis/.eunit/index.html
==> example_db (eunit)
Compiled src/example_db.erl
  All 3 tests passed.
Cover analysis: /private/tmp/example_db/.eunit/index.html
<code>
All seems to be fine! lets create file called  `start.sh` to test it out
</code> bash
λ cat start.sh
erl -pa ebin -pa deps/*/ebin
<code>``
and make it executable with</code>chmod +x start.sh`</p>

<p>And lets rock &lsquo;n&rsquo; roll</p>

<p>``` bash
 λ ./start.sh
Erlang R15B (erts-5.9) [source] [64-bit] [smp:4:4] [async-threads:0] [hipe] [kernel-poll:false]</p>

<p>Eshell V5.9  (abort with ^G)
1> example_db:start_link().
{ok,&lt;0.33.0>}
2> example_db:save_script(&ldquo;example&rdquo;, &ldquo;script&rdquo;, &ldquo;puts &lsquo;2+2&rsquo;&rdquo;).
{ok,&lt;&lt;&ldquo;OK&rdquo;>>}
3> example_db:get_script(&ldquo;example&rdquo;, &ldquo;script&rdquo;).
{ok,&lt;&lt;&ldquo;puts &lsquo;2+2&rsquo;&rdquo;>>}
```
Have fun :) Hope it was useful. You can download code for this blog post here <a href="https://github.com/JakubOboza/example_db-code">https://github.com/JakubOboza/example_db-code</a></p>

<h3>Huh ^___^</h3>

<p>that was my first post on new blog ;)</p>
]]></content>
  </entry>
  
</feed>
